---
title: "GRLS HSA vs non-HSA logistic regression"
format: html
editor: visual
---

## HSA GRLS cohort

HSA cases vs non-case control logistic regression

```{r}
library(tidyverse)
library(tidyverse)
library(dplyr)
library(survival)
library(ggplot2)
library(tibble)
library(kableExtra)
library(epiDisplay)
library(lme4)
#devtools::install_github("zabore/ezfun")
ezfun::set_ccf_palette("contrast")
library(lubridate)
library(ggsurvfit)
library(gtsummary)
library(tidycmprsk)
library(gtable)
#devtools::install_github("zabore/condsurv")
library(condsurv)
library(survminer)
library(cardx)
library(finalfit)
library(crosstable)
library(kableExtra)
library(officer)
library(flextable)
cohort_abr <-read.csv("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_cohort_all_RFs_data_tidied_from_cox.csv")
```

Converting columns to factors for analyses

```{r}

#replace all missing with NA (so "" and NA)
cohort_abr <- cohort_abr %>%
  mutate(across(everything(), as.character)) %>%  # Ensure all columns are character
  mutate(across(everything(), ~na_if(.x, "n/a"))) %>%
  mutate(across(everything(), ~na_if(.x, "NA"))) %>%
  mutate(across(everything(), ~na_if(.x, "nr"))) %>%
  mutate(across(everything(), ~na_if(.x, "not recorded"))) %>%
  mutate(across(everything(), ~na_if(.x, ""))) %>%
  mutate(across(everything(), ~replace_na(.x, "not_recorded")))
cohort_abr$survival_time_months <- as.numeric(cohort_abr$survival_time_months)


cohort_abr$status_factor <- as.factor(as.character(cohort_abr$had_HSA))
cohort_abr$status <-as.numeric(cohort_abr$had_HSA) 
cohort_abr$survival_time_months <- as.numeric(cohort_abr$survival_time_months)


#change spayed while in heat to account for males and entire females
cohort_abr <- cohort_abr %>%
  mutate(spayed_while_in_heat = case_when(
    sex== "M" ~ "Male",
    sex_status == "Intact Female" ~ "Intact Female",
    spayed_while_in_heat == "0" ~ "0",
    spayed_while_in_heat == "1" ~"1"
  ))
#same as above account for unnetered and males 
cohort_abr$heats_before_neutering <- as.numeric(cohort_abr$heats_before_neutering)
heats <- cohort_abr %>%
# Convert to numeric
  filter(heats_before_neutering != 0) %>% 
# Remove rows where the column is 0
  filter(heats_before_neutering != "not_recorded")%>%
  dplyr::select(heats_before_neutering)# Keep only this column
heats <- as.numeric(heats$heats_before_neutering)

# Function to calculate quartile or tercile dynamically
get_breaks <- function(x, probs) {
  breaks <- quantile(x, probs = probs, na.rm = TRUE)
  
  # If breaks are not unique, switch to tercile
  if (length(unique(breaks)) < length(probs)) {
    message("quartile not unique, switching to tercile.")
    breaks <- quantile(x, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE)
  }
  
  return(breaks)
}

breaks <- get_breaks(heats, c(0, 0.25, 0.5, 0.75, 1))


# Assign labels dynamically
labels <- paste0("â‰¥", round(head(breaks, -1), 2), " - <", round(tail(breaks, -1), 2))


cohort_abr <- cohort_abr %>%
  mutate(heats_before_neutering_tercile = case_when(
    sex== "M" ~ "Male",
    sex_status == "Intact Female" ~ "Intact Female",
    heats_before_neutering == "0" ~ "0",
    heats_before_neutering == "1" ~"1-<=2",
    heats_before_neutering == "2" ~"1-<=2",
    heats_before_neutering == "3" ~">2-<=4",
    heats_before_neutering == "4" ~">2-<=4",
    heats_before_neutering == "5" ~">4-12",
    heats_before_neutering == "6" ~">4-12",
    heats_before_neutering == "7" ~">4-12",
    heats_before_neutering == "8" ~">4-12",
    heats_before_neutering == "9" ~">4-12",
    heats_before_neutering == "10" ~">4-12",
    heats_before_neutering == "11" ~">4-12",
    heats_before_neutering == "12" ~">4-12"
  ))


#create combined sex neuter variable
cohort_abr <- cohort_abr %>%
  mutate(sex_neuter = paste(sex, neuter, sep = " "))


#ensure not_recorded is default not baseline
convert_and_relevel <- function(df) {
  df <- df %>%
    mutate(across(where(is.character), ~ factor(.))) %>%  # Convert all character columns to factors
    mutate(across(where(is.factor), ~ fct_relevel(., "not_recorded", after = Inf)))  # Move "not_recorded" to last place
  return(df)
}

# Apply to your dataset
cohort_abr <- convert_and_relevel(cohort_abr)



cohort_abr <- cohort_abr%>%
  mutate(heats_before_neutering_tercile = factor(heats_before_neutering_tercile, levels = c("0", "1-<=2", ">2-<=4", ">4-12","Intact Female","Male","not_recorded")))


#neuter reason levels
cohort_abr <- cohort_abr%>%
  mutate(neutered_reason = factor(neutered_reason, levels = c("Elective",  "Medical Reason", "Entire","Unknown")))


cohort_abr <- cohort_abr%>%
  mutate(mode_purina_BCS_5y_prior_endpoint = factor(mode_purina_BCS_5y_prior_endpoint, levels = c("5", "3", "4", "6","7","8","9","not_recorded")))

#change BCS to be over underweight
cohort_abr <- cohort_abr %>%
  mutate(mode_BCS_classify = case_when(
    mode_purina_BCS_5y_prior_endpoint == "1" ~"underweight",
    mode_purina_BCS_5y_prior_endpoint == "2" ~"underweight",
    mode_purina_BCS_5y_prior_endpoint == "3" ~"underweight",
    mode_purina_BCS_5y_prior_endpoint == "4" ~"ideal",
    mode_purina_BCS_5y_prior_endpoint == "5" ~"ideal",
    mode_purina_BCS_5y_prior_endpoint == "6" ~"overweight",
    mode_purina_BCS_5y_prior_endpoint == "7" ~"overweight",
    mode_purina_BCS_5y_prior_endpoint == "8" ~"overweight",
    mode_purina_BCS_5y_prior_endpoint == "9" ~"overweight",
  ))

#set age levels
cohort_abr <- cohort_abr%>%
  mutate(age_at_final_date_quartiles = factor(age_at_final_date_quartiles, levels = c("0.74-<8.47 years", ">=8.47-<10.68 years", ">=10.68-<11.64 years", ">=11.64-14.51 years")))

cohort_abr <- cohort_abr%>%
  mutate(age_at_final_date_bio = factor(age_at_final_date_bio, levels = c(">5-<8y","<5y",  ">8-<11y", ">11-<13y",">13y")))

cohort_abr <- cohort_abr%>%
  mutate(age_at_final_date_GB = factor(age_at_final_date_GB, levels = c(">7-<9y","<5y", ">5-<7y",  ">9-<11y",">11-<13y",">13y")))


#manually assign height, weight, BCS factor levles and age at neuter and age at diagnosis 
#height
cohort_abr <- cohort_abr%>%
  mutate(avg_height_5y_prior_endpoint_quartiles = factor(avg_height_5y_prior_endpoint_quartiles, levels = c("49.80-<56.30cm", ">=56.30-<58.29cm", ">=58.29-<60.32cm", ">=60.32cm-67.73cm","not_recorded")))
#weight
cohort_abr <- cohort_abr%>%
  mutate(avg_weight_5y_prior_endpoint_quartiles = factor(avg_weight_5y_prior_endpoint_quartiles, levels = c("12.47-<20.83kg", ">=20.83-<23.23kg", ">=23.23-26.98kg", ">=26.98-37.01","not_recorded")))


#recoding weight levels here so the <15kg dogs are now "not_recorded"
cohort_abr <- cohort_abr %>%
  mutate(avg_weight_5y_prior_endpoint_kg_biological = case_when(
    avg_weight_5y_prior_endpoint_kg_biological == "<15kg" ~ "not_recorded",
    TRUE ~ avg_weight_5y_prior_endpoint_kg_biological
  ))
cohort_abr <- cohort_abr%>%
  mutate(avg_weight_5y_prior_endpoint_kg_biological = factor(avg_weight_5y_prior_endpoint_kg_biological, levels = c(">15-<=25kg",">25-<=35kg",">35","not_recorded")))

#weight median any records in 5y
cohort_abr <- cohort_abr%>%
  mutate(median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_quartiles = factor(median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_quartiles, levels = c("10.5-<17.1kg", ">=17.1-<24.7kg", ">=24.7-30.6kg", ">=30.6-49.1kg","not_recorded")))

cohort_abr <- cohort_abr%>%
  mutate(median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_biological = factor(median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_biological, levels = c(">15-<=25kg",">25-<=35kg",">35","not_recorded")))
#weight median all 5 record years
cohort_abr <- cohort_abr%>%
  mutate(median_weight_5y_prior_endpoint_kg_outliers_removed_quartiles = factor(median_weight_5y_prior_endpoint_kg_outliers_removed_quartiles, levels = c("10.5-<16.1kg", ">=16.1-<21.3kg", ">=21.3-28.8kg", ">=28.8-47.1kg","not_recorded")))


cohort_abr <- cohort_abr%>%
  mutate(median_weight_5y_prior_endpoint_kg_outliers_removed_biological = factor(median_weight_5y_prior_endpoint_kg_outliers_removed_biological, levels = c(">15-<=25kg",">25-<=35kg",">35","not_recorded")))



cohort_abr <- cohort_abr%>%
  mutate(avg_purina_BCS_5y_prior_endpoint_quartiles = factor(avg_purina_BCS_5y_prior_endpoint_quartiles, levels = c("3.3-<5", ">=5-<5.28", ">=5.28-<5.86", ">=5.86 - 9","not_recorded")))
#neut age

cohort_abr <- cohort_abr%>%
  mutate(age_at_neuter_years_quartiles = factor(age_at_neuter_years_quartiles, levels = c("0.15-<0.52y", ">=0.52-<0.83y", ">=0.83-2.44y", ">=2.44-9.59y","Entire","not_recorded")))
#diagnosis age
cohort_abr <- cohort_abr%>%
  mutate(age_at_final_date_quartiles = factor(age_at_final_date_quartiles, levels = c("0.74-<8.47 years", ">=8.47-<10.68 years", ">=10.68-<11.64 years", ">=11.64-14.51 years","not_recorded")))

#breed tercile levels
cohort_abr <- cohort_abr%>%
  mutate(num_breeding_before_neutering_terciles = factor(num_breeding_before_neutering_terciles, levels = c(">0-<3",">=3-<9",">=9-142","not_bred","not_recorded")))


#recode NSAID quartiles

cohort_abr <- cohort_abr%>%
  mutate(NSAID_5y_quantiles = factor(NSAID_5y_quantiles, levels = c("no_NSAID_admin", "Q1(1)", "Q2(1-2)", "Q3(2-3)","Q4(3-11)","no_med_use_recorded")))

cohort_abr <- cohort_abr%>%
  mutate(endo_5y_quantiles = factor(endo_5y_quantiles, levels = c("no_endo_admin", "Q1(1-2)", "Q2(2-3)", "Q3(3-4)","Q4(4-17)","no_med_use_recorded")))

cohort_abr <- cohort_abr%>%
  mutate(ecto_5y_quantiles = factor(ecto_5y_quantiles, levels = c("no_ecto_admin", "Q1(1)", "Q2(1-2)", "Q3(2-4)","Q4(4-17)","no_med_use_recorded")))
###setting "no_medication_records_for_this_time_periodistered" as bottom factor level for drug variables as think it actually means drug use not recorded so doesnt make a good baseline
# Vector of the column names to modify
# Suppose you want to modify columns 3 to 17, for example
cols_to_modify <- 198:265  # replace with your actual column indices

for (i in cols_to_modify) {
  current_levels <- levels(cohort_abr[[i]])
  if ("no_medication_records_for_this_time_period" %in% current_levels) {
    new_levels <- c(setdiff(current_levels, "no_medication_records_for_this_time_period"), "no_medication_records_for_this_time_period")
    cohort_abr[[i]] <- factor(cohort_abr[[i]], levels = new_levels)
  }
}



```

Activity datasets very challenging to explain the cut-offs quartile for interpretation so going to attempt to split into more biologically meaningful categories based on original script splits - C:/Users/ctaylor18/GitHub/GRLS_analyses/Code/GRLS activity classifcation method_modified.qmd Columns to modify: - duration, freq and intensity SY1_2 - intensity freq SY3 beyond - intensity freq 5y prior

Also going to group to more meaningful categories e.g slow and average walks together, rarely and monthly activity together

```{r}
#SY1 and 2
cohort_abr <- cohort_abr %>%
  mutate(avg_activity_duration_sy1_2 = as.numeric(as.character(avg_activity_duration_sy1_2))) %>%
  mutate(avg_activity_duration_sy1_2_splits = case_when(
    avg_activity_duration_sy1_2 <= 20 ~ "less_than_30min",
    avg_activity_duration_sy1_2 >20 & avg_activity_duration_sy1_2 <= 40 ~ "between_30_60_min",
    avg_activity_duration_sy1_2 >40 & avg_activity_duration_sy1_2<= 60 ~ "between_60_90_min",
    avg_activity_duration_sy1_2 >60 & avg_activity_duration_sy1_2 <= 80 ~ "between_90_120_min",
    avg_activity_duration_sy1_2 >80 & avg_activity_duration_sy1_2 <= 100 ~ "more_than_120_min"
  ))

cohort_abr <- cohort_abr %>%
  mutate(avg_activity_freq_sy1_2 = as.numeric(as.character(avg_activity_freq_sy1_2))) %>%
  mutate(avg_activity_freq_sy1_2_splits = case_when(
    avg_activity_freq_sy1_2 <= 20 ~ "never",
    avg_activity_freq_sy1_2 >20 & avg_activity_freq_sy1_2<= 40 ~ "less_than_weekly",
    avg_activity_freq_sy1_2 >40 & avg_activity_freq_sy1_2<= 60 ~ "min_weekly",
    avg_activity_freq_sy1_2 >60 & avg_activity_freq_sy1_2 <= 80 ~ "daily",
    avg_activity_freq_sy1_2 >80 & avg_activity_freq_sy1_2<= 100 ~ "multi_daily"
  ))


cohort_abr <- cohort_abr %>%
  mutate(avg_activity_intensity_sy1_2 = as.numeric(as.character(avg_activity_intensity_sy1_2))) %>%
  mutate(avg_activity_intensity_sy1_2_splits = case_when(
    avg_activity_intensity_sy1_2 <= 33.3 ~ "low",
    avg_activity_intensity_sy1_2 >33.3 & avg_activity_intensity_sy1_2<= 66.7 ~ "moderate",
    avg_activity_intensity_sy1_2 >66.7 & avg_activity_intensity_sy1_2<= 100 ~ "high",

  ))

#SY3 + intensity and freq


cohort_abr <- cohort_abr %>%
  mutate(avg_activity_freq_sy3 = as.numeric(as.character(avg_activity_freq_sy3))) %>%
  mutate(avg_activity_freq_sy3_splits = case_when(
    avg_activity_freq_sy3 <= 20 ~ "rarely",
    avg_activity_freq_sy3 >20 & avg_activity_freq_sy3<= 40 ~ "monthly",
    avg_activity_freq_sy3 >40 & avg_activity_freq_sy3<= 60 ~ "weekly",
    avg_activity_freq_sy3 >60 & avg_activity_freq_sy3 <= 80 ~ "daily",
    avg_activity_freq_sy3 >80 & avg_activity_freq_sy3<= 100 ~ "multi_daily"
  ))


cohort_abr <- cohort_abr %>%
  mutate(avg_activity_intensity_sy3 = as.numeric(as.character(avg_activity_intensity_sy3))) %>%
  mutate(avg_activity_intensity_sy3_splits = case_when(
    avg_activity_intensity_sy3 <= 20 ~ "slow_walks",
    avg_activity_intensity_sy3 >20 & avg_activity_intensity_sy3<= 40 ~ "average_walks",
    avg_activity_intensity_sy3 >40 & avg_activity_intensity_sy3<= 60 ~ "brisk_walks",
    avg_activity_intensity_sy3 >60 & avg_activity_intensity_sy3 <= 80 ~ "jogs",
    avg_activity_intensity_sy3 >80 & avg_activity_intensity_sy3<= 100 ~ "runs"
  ))



#5y prior endpoint  freq


cohort_abr <- cohort_abr %>%
  mutate(avg_frequency_5y_prior_endpoint = as.numeric(as.character(avg_activity_freq_sy3))) %>%
  mutate(avg_frequency_5y_prior_endpoint_splits = case_when(
    avg_frequency_5y_prior_endpoint <= 20 ~ "rarely",
    avg_frequency_5y_prior_endpoint >20 & avg_frequency_5y_prior_endpoint<= 40 ~ "monthly",
    avg_frequency_5y_prior_endpoint >40 & avg_frequency_5y_prior_endpoint<= 60 ~ "weekly",
    avg_frequency_5y_prior_endpoint >60 & avg_frequency_5y_prior_endpoint <= 80 ~ "daily",
    avg_frequency_5y_prior_endpoint >80 &avg_frequency_5y_prior_endpoint<= 100 ~ "multi_daily"
  ))
#5y prior endpoint intensity
cohort_abr <- cohort_abr %>%
  mutate(avg_intensity_5y_prior_endpoint = as.numeric(as.character(avg_intensity_5y_prior_endpoint))) %>%
  mutate(avg_intensity_5y_prior_endpoint_splits = case_when(
    avg_intensity_5y_prior_endpoint <= 20 ~ "slow_walks",
    avg_intensity_5y_prior_endpoint >20 & avg_intensity_5y_prior_endpoint<= 40 ~ "average_walks",
    avg_intensity_5y_prior_endpoint >40 & avg_intensity_5y_prior_endpoint<= 60 ~ "brisk_walks",
    avg_intensity_5y_prior_endpoint >60 & avg_intensity_5y_prior_endpoint <= 80 ~ "jogs",
    avg_intensity_5y_prior_endpoint >80 & avg_intensity_5y_prior_endpoint<= 100 ~ "runs"
  ))
#recode into larger groupings e.g grouping together rarely + monthly for frequency
#freq
cohort_abr <- cohort_abr %>%
  mutate(avg_activity_freq_sy3_splits_grouped = case_when(
    avg_activity_freq_sy3_splits == "monthly" ~ "rarely",
    avg_activity_freq_sy3_splits == "multi_daily"~"daily_or_more" ,
    avg_activity_freq_sy3_splits == "daily" ~"daily_or_more" ,
    avg_activity_freq_sy3_splits == "weekly" ~"weekly" ,
    avg_activity_freq_sy3_splits == "rarely" ~ "rarely",
  ))

#intensity
cohort_abr <- cohort_abr %>%
  mutate(avg_activity_intensity_sy3_splits_grouped = case_when(
    avg_activity_intensity_sy3_splits == "jogs" ~ "high_intensity",
    avg_activity_intensity_sy3_splits == "runs" ~"high_intensity" ,
    avg_activity_intensity_sy3_splits == "brisk_walks" ~"moderate_intensity",
    avg_activity_intensity_sy3_splits =="average_walks" ~ "low_intensity",
     avg_activity_intensity_sy3_splits =="slow_walks" ~ "low_intensity"
  ))
#5y prior freq
cohort_abr <- cohort_abr %>%
  mutate(avg_frequency_5y_prior_endpoint_splits_grouped = case_when(
    avg_frequency_5y_prior_endpoint_splits == "monthly" ~ "rarely",
    avg_frequency_5y_prior_endpoint_splits == "multi_daily"~"daily_or_more" ,
    avg_frequency_5y_prior_endpoint_splits == "daily" ~"daily_or_more" ,
    avg_frequency_5y_prior_endpoint_splits == "weekly" ~"weekly" ,
    avg_frequency_5y_prior_endpoint_splits == "rarely" ~"rarely" ,
  ))

#5y prior intensity
cohort_abr <- cohort_abr %>%
  mutate(avg_intensity_5y_prior_endpoint_splits_grouped = case_when(
    avg_intensity_5y_prior_endpoint_splits == "jogs" ~ "high_intensity",
    avg_intensity_5y_prior_endpoint_splits == "runs" ~"high_intensity" ,
    avg_intensity_5y_prior_endpoint_splits == "brisk_walks" ~"moderate_intensity",
    avg_intensity_5y_prior_endpoint_splits =="average_walks" ~ "low_intensity",
    avg_intensity_5y_prior_endpoint_splits =="slow_walks" ~ "low_intensity"
  ))
#swap not_recorded for NA and exclude from univar this way
cohort_no_not_rec <- cohort_abr %>%
  mutate(across(
    where(~ is.character(.) | is.factor(.)),
    ~ factor(na_if(as.character(.), "not_recorded"))
  ))



```

## Univariable logstic regression

-   Counts

```{r}
dependent <- "had_HSA"

# All other variables as explanatory variables
explanatory = c(
  #demog
  "age_at_final_date_GB","age_at_final_date_bio", "age_at_final_date_quartiles","age_at_neuter_years_quartiles","sex_neuter",
   "sex", "neuter", "mismating_ever",
             "neutered_reason", "neutered_ever_bred", "spayed_while_in_heat", "spayed_while_pregnant", "prevent_heat_ever", 
             "no_pregnancy_ever", "intact_sired_litters_natural_ever", "neutered_females_bred_with_count_ever", 
             "neutered_sired_litters_natural_ever", "heats_before_neutering", "heats_before_neutering_terciles",
             "preg_pre_neuter",
 "num_breeding_before_neutering_terciles", "ever_bred_from", 
              "avg_weight_5y_prior_endpoint_quartiles","avg_weight_5y_prior_endpoint_kg_biological", "avg_height_5y_prior_endpoint_quartiles", 
             "avg_purina_BCS_5y_prior_endpoint_quartiles","median_weight_5y_prior_endpoint_kg_outliers_removed_quartiles","median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_quartiles", "mode_purina_BCS_5y_prior_endpoint","median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_biological","median_weight_5y_prior_endpoint_kg_outliers_removed_biological", "mode_BCS_classify",
  #lifestyle/activity
  "main_lifestyle_category", 
 "main_lifestyle_category_mode_5yrs_prior", "USDA_30min_sy1_2", "activity_1h_min_sy1_2", 
             "activity_KC_2h_min_sy1_2", "avg_activity_duration_sy1_2_quartile",
 "avg_activity_intensity_sy3_quartile", "avg_intensity_5y_prior_endpoint_quartile", "avg_frequency_5y_prior_endpoint_quartile", "avg_activity_duration_sy1_2_splits",
 "avg_activity_freq_sy1_2_splits", 
             "avg_activity_freq_sy3_splits", "avg_activity_intensity_sy3_splits",  "avg_frequency_5y_prior_endpoint_splits",
             "avg_activity_freq_sy3_splits_grouped", "avg_activity_intensity_sy3_splits_grouped",  "avg_frequency_5y_prior_endpoint_splits_grouped","avg_intensity_5y_prior_endpoint_splits","avg_intensity_5y_prior_endpoint_splits_grouped",
  #home/environmental
  "MDI_quintile","owner_MDI_quintile","area_type_mode_5yrs_prior","house_type_mode_5yrs_prior", 
             "water_source_mode_5yrs_prior", "pipes_metal_any_mode_5yrs_prior", "pipes_plastic_any_mode_5yrs_prior", 
             "heating_fuel_primary_mode_5yrs_prior", "cooking_fuel_primary_mode_5yrs_prior", "heating_fuel_secondary_mode_5yrs_prior", 
             "cooking_fuel_secondary_mode_5yrs_prior", "region_mode_5y_prior","use_aerosol_study_years_early_life", "use_air_cleaner_study_years_early_life", "use_hepa_filter_study_years_early_life", 
             "use_moth_balls_study_years_early_life", "use_incense_or_candles_study_years_early_life", "smoke_exposure_study_years_early_life",  "use_aerosol_study_years_rest_of_life", 
             "use_air_cleaner_study_years_rest_of_life", "use_hepa_filter_study_years_rest_of_life", "use_moth_balls_study_years_rest_of_life", 
             "use_incense_or_candles_study_years_rest_of_life", "smoke_exposure_study_years_rest_of_life", "any_treated_weeds_study_years_rest_of_life", 
             "any_treated_insects_study_years_rest_of_life", "any_treated_fertilizer_study_years_rest_of_life","use_aerosol_study_years_whole_life", 
             "use_air_cleaner_study_years_whole_life", "use_hepa_filter_study_years_whole_life", "use_moth_balls_study_years_whole_life", 
             "use_incense_or_candles_study_years_whole_life", "smoke_exposure_study_years_whole_life", "any_treated_weeds_study_years_whole_life", 
             "any_treated_insects_study_years_whole_life", "any_treated_fertilizer_study_years_whole_life", "hours_of_smoke_early_life_total_dosage_terciles", "hours_of_smoke_rest_of_life_total_dosage_terciles", 
             "hours_of_smoke_whole_life_total_dosage_terciles", "in.the.garage_YN_study_years_early_life", "in.the.house_YN_study_years_early_life", 
             "outside_YN_study_years_early_life",  
             "in.the.garage_YN_study_years_rest_of_life", "in.the.house_YN_study_years_rest_of_life", "outside_YN_study_years_rest_of_life", 
              "in.the.house_YN_sum_rest_of_life_quartile",  
             "in.the.garage_YN_study_years_whole_life", "in.the.house_YN_study_years_whole_life", "outside_YN_study_years_whole_life", 
             "in.the.house_YN_sum_whole_life_quartile",  
             "majority_sleep_location_lifetime","sleep_location_mode_5yrs_prior", 
             "use_aerosol_exposed_5yrs_prior", "use_air_cleaner_exposed_5yrs_prior", "use_hepa_filter_exposed_5yrs_prior", 
             "use_moth_balls_exposed_5yrs_prior", "use_incense_or_candles_exposed_5yrs_prior", "smoke_exposure_exposed_5yrs_prior", 
             "any_treated_weeds_exposed_5yrs_prior", "any_treated_insects_exposed_5yrs_prior", "any_treated_fertilizer_exposed_5yrs_prior", 
  #comorbidities
  "chronic_inflam_present_lifetime","number_comorbs_present_lifetime","chronic_inflam_present.x","chronic_inflam_present_5y","number_comorbs_present_5y","chronic_inflam_present_no_min_year","number_comorbs_present_no_min_year","intestinal_parasitism","tick_borne_parasitism","other_parasitism","all_parasitism","infectious","immune_mediated","cardiovascular","gastrointestinal","inflammatory_other","orthopaedic","chronic_inflammatory","lifelong_comorb_present.x","lifelong_orthopaedic","lifelong_immune_mediated","lifelong_cardiovascular","lifelong_gastrointestinal","lifelong_inflammatory_other","lifelong_chronic_inflammatory","number_lifelong_comorbs_present","malig_cancers_count","benign_cancers_count","all_cancers_count","all_cancers_YN","benign_cancers_YN","malig_cancers_YN","all_cancers_count_no_HSA","malig_cancers_count_no_HSA","malig_cancers_YN_no_HSA","all_cancers_YN_no_HSA","lymphoma_present","carcinoma_present","sarcoma_present","melanoma_present","adenocarcinoma_present","mast_cell_tumor_present",
  #medications
  "half_anti_microbials_lifetime", "half_dietary_supplements_lifetime", 
             "half_enteric_lifetime", "half_fluid_metabolites_lifetime", "half_hormones_and_related_lifetime", "half_immunologicals_lifetime", 
             "half_misc_lifetime", "half_neurological_lifetime", "half_anti_parasites_lifetime", "half_anti_septics_lifetime", 
             "half_cardio_respiratory_lifetime", "half_diuretics_lifetime", "half_anti_hist_lifetime", 
             "quartile_anti_inflam_lifetime", "quartile_anti_microbials_lifetime", "quartile_dietary_supplements_lifetime", 
 "quartile_hormones_and_related_lifetime", 
             "quartile_immunologicals_lifetime", "quartile_misc_lifetime", "quartile_neurological_lifetime", 
             "quartile_anti_parasites_lifetime", 
             "half_anti_inflam_5y_prior_endpoint", "half_anti_microbials_5y_prior_endpoint", "half_enteric_5y_prior_endpoint", 
             "half_immunologicals_5y_prior_endpoint", "half_misc_5y_prior_endpoint", "half_neurological_5y_prior_endpoint", 
             "half_anti_parasites_5y_prior_endpoint", "half_dietary_supplements_5y_prior_endpoint", 
             "half_anti_septics_5y_prior_endpoint", "half_hormones_and_related_5y_prior_endpoint", 
             "half_cardio_respiratory_5y_prior_endpoint", "half_fluid_metabolites_5y_prior_endpoint", 
             "half_diuretics_5y_prior_endpoint", "half_anti_hist_5y_prior_endpoint", 
             "quartile_anti_inflam_5y_prior_endpoint", "quartile_anti_microbials_5y_prior_endpoint",  "quartile_immunologicals_5y_prior_endpoint", 
             "quartile_misc_5y_prior_endpoint", "quartile_neurological_5y_prior_endpoint", 
             "quartile_anti_parasites_5y_prior_endpoint", "quartile_dietary_supplements_5y_prior_endpoint", 
 "quartile_hormones_and_related_5y_prior_endpoint", "NSAID_5y","NSAID_ever","NSAID_5y_quantiles","steroid_5y","steroid_ever","fenbendazole_5y","fenbendazole_ever","ecto_5y_quantiles","endo_5y_quantiles"
)

# Create a univariable logistic regression table
univar_table <- cohort_abr %>%summary_factorlist(dependent, explanatory, 
  p=TRUE,  add_dependent_label=TRUE,column = TRUE)
#column = TRUE does case and contorl counts for each variable category rather than rowise

univar_table2 <- cohort_abr %>%summary_factorlist(dependent, explanatory, 
  p=TRUE,  add_dependent_label=TRUE,na_include = TRUE,column=TRUE)
# View the results
print(univar_table)
write.csv(univar_table,"C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_cross_table_case_control_output.csv")

#save as worddoc
# Install and load the required packages
library(officer)
library(flextable)

# Create a Word document
doc <- read_docx()

# Convert finalfit output to a flextable
results_flextable <- flextable(univar_table)

# Add the flextable to the Word document
doc <- doc %>%
  body_add_flextable(results_flextable) %>%
  body_add_par("Finalfit Regression Results", style = "heading 1")

# Save the Word document
print(doc, target = "C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_cross_table_case_control_output.docx")
```

-   Univar log reg with ORs

```{r}
source("C:/Users/ctaylor18/GitHub/HSA-VC-enviro-analyses/functions/univar_log_reg_auto.R")

cohort_abr$had_HSA <- as.factor(cohort_abr$had_HSA)



#leaving out the continuous variables as missing data causing issues
#"max_tumour_cm_value" "age_at_diagnosis_cont"
cohort_abr2 <- cohort_abr %>%
  dplyr::select(   #demog
  "age_at_final_date_GB","age_at_final_date_bio", "age_at_final_date_quartiles","age_at_neuter_years_quartiles","sex_neuter",
   "sex", "neuter", "mismating_ever",
             "neutered_reason", "neutered_ever_bred", "spayed_while_in_heat", "spayed_while_pregnant", "prevent_heat_ever", 
             "no_pregnancy_ever", "intact_sired_litters_natural_ever", "neutered_females_bred_with_count_ever", 
             "neutered_sired_litters_natural_ever", "heats_before_neutering", "heats_before_neutering_terciles",
             "preg_pre_neuter",
 "num_breeding_before_neutering_terciles", "ever_bred_from", 
              "avg_weight_5y_prior_endpoint_quartiles","avg_weight_5y_prior_endpoint_kg_biological", "avg_height_5y_prior_endpoint_quartiles", "median_weight_5y_prior_endpoint_kg_outliers_removed_quartiles","median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_quartiles", "mode_purina_BCS_5y_prior_endpoint","median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_biological","median_weight_5y_prior_endpoint_kg_outliers_removed_biological", 
             "avg_purina_BCS_5y_prior_endpoint_quartiles", "mode_purina_BCS_5y_prior_endpoint", "mode_BCS_classify",
  #lifestyle/activity
  "main_lifestyle_category", 
 "main_lifestyle_category_mode_5yrs_prior", "USDA_30min_sy1_2", "activity_1h_min_sy1_2", 
             "activity_KC_2h_min_sy1_2", "avg_activity_duration_sy1_2_quartile",
 "avg_activity_intensity_sy3_quartile", "avg_intensity_5y_prior_endpoint_quartile", "avg_frequency_5y_prior_endpoint_quartile", "avg_activity_duration_sy1_2_splits",
 "avg_activity_freq_sy1_2_splits", 
             "avg_activity_freq_sy3_splits", "avg_activity_intensity_sy3_splits",  "avg_frequency_5y_prior_endpoint_splits",
             "avg_activity_freq_sy3_splits_grouped", "avg_activity_intensity_sy3_splits_grouped",  "avg_frequency_5y_prior_endpoint_splits_grouped","avg_intensity_5y_prior_endpoint_splits","avg_intensity_5y_prior_endpoint_splits_grouped",
  #home/environmental
  "MDI_quintile","owner_MDI_quintile","area_type_mode_5yrs_prior","house_type_mode_5yrs_prior", 
             "water_source_mode_5yrs_prior", "pipes_metal_any_mode_5yrs_prior", "pipes_plastic_any_mode_5yrs_prior", 
             "heating_fuel_primary_mode_5yrs_prior", "cooking_fuel_primary_mode_5yrs_prior", "heating_fuel_secondary_mode_5yrs_prior", 
             "cooking_fuel_secondary_mode_5yrs_prior", "region_mode_5y_prior","use_aerosol_study_years_early_life", "use_air_cleaner_study_years_early_life", "use_hepa_filter_study_years_early_life", 
             "use_moth_balls_study_years_early_life", "use_incense_or_candles_study_years_early_life", "smoke_exposure_study_years_early_life",  "use_aerosol_study_years_rest_of_life", 
             "use_air_cleaner_study_years_rest_of_life", "use_hepa_filter_study_years_rest_of_life", "use_moth_balls_study_years_rest_of_life", 
             "use_incense_or_candles_study_years_rest_of_life", "smoke_exposure_study_years_rest_of_life", "any_treated_weeds_study_years_rest_of_life", 
             "any_treated_insects_study_years_rest_of_life", "any_treated_fertilizer_study_years_rest_of_life","use_aerosol_study_years_whole_life", 
             "use_air_cleaner_study_years_whole_life", "use_hepa_filter_study_years_whole_life", "use_moth_balls_study_years_whole_life", 
             "use_incense_or_candles_study_years_whole_life", "smoke_exposure_study_years_whole_life", "any_treated_weeds_study_years_whole_life", 
             "any_treated_insects_study_years_whole_life", "any_treated_fertilizer_study_years_whole_life", "hours_of_smoke_early_life_total_dosage_terciles", "hours_of_smoke_rest_of_life_total_dosage_terciles", 
             "hours_of_smoke_whole_life_total_dosage_terciles", "in.the.garage_YN_study_years_early_life", "in.the.house_YN_study_years_early_life", 
             "outside_YN_study_years_early_life",  
             "in.the.garage_YN_study_years_rest_of_life", "in.the.house_YN_study_years_rest_of_life", "outside_YN_study_years_rest_of_life", 
              "in.the.house_YN_sum_rest_of_life_quartile",  
             "in.the.garage_YN_study_years_whole_life", "in.the.house_YN_study_years_whole_life", "outside_YN_study_years_whole_life", 
             "in.the.house_YN_sum_whole_life_quartile",  
             "majority_sleep_location_lifetime","sleep_location_mode_5yrs_prior", 
             "use_aerosol_exposed_5yrs_prior", "use_air_cleaner_exposed_5yrs_prior", "use_hepa_filter_exposed_5yrs_prior", 
             "use_moth_balls_exposed_5yrs_prior", "use_incense_or_candles_exposed_5yrs_prior", "smoke_exposure_exposed_5yrs_prior", 
             "any_treated_weeds_exposed_5yrs_prior", "any_treated_insects_exposed_5yrs_prior", "any_treated_fertilizer_exposed_5yrs_prior", 
  #comorbidities
  "chronic_inflam_present_lifetime","number_comorbs_present_lifetime","chronic_inflam_present.x","chronic_inflam_present_5y","number_comorbs_present_5y","chronic_inflam_present_no_min_year","number_comorbs_present_no_min_year","intestinal_parasitism","tick_borne_parasitism","other_parasitism","all_parasitism","infectious","immune_mediated","cardiovascular","gastrointestinal","inflammatory_other","orthopaedic","chronic_inflammatory","lifelong_comorb_present.x","lifelong_orthopaedic","lifelong_immune_mediated","lifelong_cardiovascular","lifelong_gastrointestinal","lifelong_inflammatory_other","lifelong_chronic_inflammatory","number_lifelong_comorbs_present","malig_cancers_count","benign_cancers_count","all_cancers_count","all_cancers_YN","benign_cancers_YN","malig_cancers_YN","all_cancers_count_no_HSA","malig_cancers_count_no_HSA","malig_cancers_YN_no_HSA","all_cancers_YN_no_HSA","lymphoma_present","carcinoma_present","sarcoma_present","melanoma_present","adenocarcinoma_present","mast_cell_tumor_present",
  #medications
  "half_anti_microbials_lifetime", "half_dietary_supplements_lifetime", 
             "half_enteric_lifetime", "half_fluid_metabolites_lifetime", "half_hormones_and_related_lifetime", "half_immunologicals_lifetime", 
             "half_misc_lifetime", "half_neurological_lifetime", "half_anti_parasites_lifetime", "half_anti_septics_lifetime", 
             "half_cardio_respiratory_lifetime", "half_diuretics_lifetime", "half_anti_hist_lifetime", 
             "quartile_anti_inflam_lifetime", "quartile_anti_microbials_lifetime", "quartile_dietary_supplements_lifetime", 
 "quartile_hormones_and_related_lifetime", 
             "quartile_immunologicals_lifetime", "quartile_misc_lifetime", "quartile_neurological_lifetime", 
             "quartile_anti_parasites_lifetime", 
             "half_anti_inflam_5y_prior_endpoint", "half_anti_microbials_5y_prior_endpoint", "half_enteric_5y_prior_endpoint", 
             "half_immunologicals_5y_prior_endpoint", "half_misc_5y_prior_endpoint", "half_neurological_5y_prior_endpoint", 
             "half_anti_parasites_5y_prior_endpoint", "half_dietary_supplements_5y_prior_endpoint", 
             "half_anti_septics_5y_prior_endpoint", "half_hormones_and_related_5y_prior_endpoint", 
             "half_cardio_respiratory_5y_prior_endpoint", "half_fluid_metabolites_5y_prior_endpoint", 
             "half_diuretics_5y_prior_endpoint", "half_anti_hist_5y_prior_endpoint", 
             "quartile_anti_inflam_5y_prior_endpoint", "quartile_anti_microbials_5y_prior_endpoint",  "quartile_immunologicals_5y_prior_endpoint", 
             "quartile_misc_5y_prior_endpoint", "quartile_neurological_5y_prior_endpoint", 
             "quartile_anti_parasites_5y_prior_endpoint", "quartile_dietary_supplements_5y_prior_endpoint", 
 "quartile_hormones_and_related_5y_prior_endpoint", "NSAID_5y","NSAID_ever","NSAID_5y_quantiles","steroid_5y","steroid_ever","fenbendazole_5y","fenbendazole_ever", "ecto_5y_quantiles","endo_5y_quantiles","had_HSA")

cohort_abr2<- cohort_abr2%>%
  mutate_all(~factor(ifelse(is.na(.), "not_recorded", as.character(.))))



cohort_abr2 <- cohort_abr2%>%
  mutate(heats_before_neutering_terciles = factor(heats_before_neutering_terciles, levels = c("0", "1-<=2", ">2-<=4", ">4-12","Intact Female","Male","not_recorded")))


#neuter reason levels
cohort_abr2<- cohort_abr2%>%
  mutate(neutered_reason = factor(neutered_reason, levels = c("Elective",  "Medical Reason", "Entire","Unknown","not_recorded")))


cohort_abr2 <- cohort_abr2%>%
  mutate(mode_purina_BCS_5y_prior_endpoint = factor(mode_purina_BCS_5y_prior_endpoint, levels = c("5", "3", "4", "6","7","8","9","not_recorded")))

#change BCS to be over underweight
cohort_abr2 <- cohort_abr2 %>%
  mutate(mode_BCS_classify = case_when(
    mode_purina_BCS_5y_prior_endpoint == "1" ~"underweight",
    mode_purina_BCS_5y_prior_endpoint == "2" ~"underweight",
    mode_purina_BCS_5y_prior_endpoint == "3" ~"underweight",
    mode_purina_BCS_5y_prior_endpoint == "4" ~"ideal",
    mode_purina_BCS_5y_prior_endpoint == "5" ~"ideal",
    mode_purina_BCS_5y_prior_endpoint == "6" ~"overweight",
    mode_purina_BCS_5y_prior_endpoint == "7" ~"overweight",
    mode_purina_BCS_5y_prior_endpoint == "8" ~"overweight",
    mode_purina_BCS_5y_prior_endpoint == "9" ~"overweight",
    mode_purina_BCS_5y_prior_endpoint == "not_recorded" ~"not_recorded",
  ))

#set age levels
cohort_abr2 <- cohort_abr2%>%
  mutate(age_at_final_date_quartiles = factor(age_at_final_date_quartiles, levels = c("0.74-<8.47 years", ">=8.47-<10.68 years", ">=10.68-<11.64 years", ">=11.64-14.51 years")))

cohort_abr2 <- cohort_abr2%>%
  mutate(age_at_final_date_bio = factor(age_at_final_date_bio, levels = c(">5-<8y","<5y",  ">8-<11y", ">11-<13y",">13y")))

cohort_abr2 <- cohort_abr2%>%
  mutate(age_at_final_date_GB = factor(age_at_final_date_GB, levels = c(">7-<9y","<5y", ">5-<7y",  ">9-<11y",">11-<13y",">13y")))


#manually assign height, weight, BCS factor levles and age at neuter and age at diagnosis 
#height
cohort_abr2 <- cohort_abr2%>%
  mutate(avg_weight_5y_prior_endpoint_quartiles = factor(avg_weight_5y_prior_endpoint_quartiles, levels = c("12.47-<20.83kg", ">=20.83-<23.23kg", ">=23.23-26.98kg", ">=26.98-37.01","not_recorded")))

cohort_abr2 <- cohort_abr2%>%
  mutate(avg_weight_5y_prior_endpoint_kg_biological = factor(avg_weight_5y_prior_endpoint_kg_biological, levels = c(">15-<=25kg",">25-<=35kg",">35","not_recorded")))

cohort_abr2 <- cohort_abr2%>%
  mutate(median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_quartiles = factor(median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_quartiles, levels = c("10.5-<17.1kg", ">=17.1-<24.7kg", ">=24.7-30.6kg", ">=30.6-49.1kg","not_recorded")))

cohort_abr2 <- cohort_abr2%>%
  mutate(median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_biological = factor(median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_biological, levels = c(">15-<=25kg",">25-<=35kg",">35","not_recorded")))
#weight median all 5 record years
cohort_abr2 <- cohort_abr2%>%
  mutate(median_weight_5y_prior_endpoint_kg_outliers_removed_quartiles = factor(median_weight_5y_prior_endpoint_kg_outliers_removed_quartiles, levels = c("10.5-<16.1kg", ">=16.1-<21.3kg", ">=21.3-28.8kg", ">=28.8-47.1kg","not_recorded")))


cohort_abr2 <- cohort_abr2%>%
  mutate(median_weight_5y_prior_endpoint_kg_outliers_removed_biological = factor(median_weight_5y_prior_endpoint_kg_outliers_removed_biological, levels = c(">15-<=25kg",">25-<=35kg",">35","not_recorded")))

#bcs
cohort_abr2 <- cohort_abr2%>%
  mutate(avg_purina_BCS_5y_prior_endpoint_quartiles = factor(avg_purina_BCS_5y_prior_endpoint_quartiles, levels = c("3.3-<5", ">=5-<5.28", ">=5.28-<5.86", ">=5.86 - 9","not_recorded")))
#neut age

cohort_abr2<- cohort_abr2 %>%
  mutate(age_at_neuter_years_quartiles = factor(age_at_neuter_years_quartiles, levels = c("0.15-<0.52y", ">=0.52-<0.83y", ">=0.83-2.44y", ">=2.44-9.59y","Entire","not_recorded")))
#diagnosis age
cohort_abr2 <- cohort_abr2%>%
  mutate(age_at_final_date_quartiles = factor(age_at_final_date_quartiles, levels = c("0.74-<8.47 years", ">=8.47-<10.68 years", ">=10.68-<11.64 years", ">=11.64-14.51 years","not_recorded")))

#breed tercile levels
cohort_abr2 <- cohort_abr2%>%
  mutate(num_breeding_before_neutering_terciles = factor(num_breeding_before_neutering_terciles, levels = c(">0-<3",">=3-<9",">=9-142","not_bred","not_recorded")))

cohort_abr2 <- cohort_abr2%>%
  mutate(NSAID_5y_quantiles = factor(NSAID_5y_quantiles, levels = c("no_NSAID_admin", "Q1(1)", "Q2(1-2)", "Q3(2-3)","Q4(3-11)","no_med_use_recorded")))


cohort_abr2 <- cohort_abr2%>%
  mutate(endo_5y_quantiles = factor(endo_5y_quantiles, levels = c("no_endo_admin", "Q1(1-2)", "Q2(2-3)", "Q3(3-4)","Q4(4-17)","no_med_use_recorded")))

cohort_abr2 <- cohort_abr2%>%
  mutate(ecto_5y_quantiles = factor(ecto_5y_quantiles, levels = c("no_ecto_admin", "Q1(1)", "Q2(1-2)", "Q3(2-4)","Q4(4-17)","no_med_use_recorded")))
cols_to_modify <- 151:200 # replace with your actual column indices

for (i in cols_to_modify) {
  current_levels <- levels(cohort_abr2[[i]])
  if ("no_medication_records_for_this_time_period" %in% current_levels) {
    new_levels <- c(setdiff(current_levels, "no_medication_records_for_this_time_period"), "no_medication_records_for_this_time_period")
    cohort_abr2[[i]] <- factor(cohort_abr2[[i]], levels = new_levels)
  }
}

#need to set the activity splits into ordinal format
cohort_abr2 <- cohort_abr2%>%
  mutate(avg_activity_freq_sy3_splits = factor(avg_activity_freq_sy3_splits, levels = c("rarely","monthly","weekly","daily","multi_daily","not_recorded")))
cohort_abr2 <- cohort_abr2%>%
  mutate(avg_activity_freq_sy1_2_splits = factor(avg_activity_freq_sy1_2_splits, levels = c("never","less_than_weekly","min_weekly","daily","multi_daily","not_recorded")))
cohort_abr2 <- cohort_abr2%>%
  mutate(avg_activity_duration_sy1_2_splits = factor(avg_activity_duration_sy1_2_splits, levels = c("less_than_30min","between_30_60_min","between_60_90_min","between_90_120_min","more_than_120_min","not_recorded")))

cohort_abr2 <- cohort_abr2%>%
  mutate(avg_activity_intensity_sy3_splits = factor(avg_activity_intensity_sy3_splits, levels = c("slow_walks","average_walks","brisk_walks","jogs","runs","not_recorded")))

cohort_abr2 <- cohort_abr2%>%
  mutate(avg_frequency_5y_prior_endpoint_splits = factor(avg_frequency_5y_prior_endpoint_splits, levels = c("rarely","monthly","weekly","daily","multi_daily","not_recorded")))
# Now run the function
univar_results <- univar_logistic_regression(cohort_abr2, "had_HSA", explanatory)

# If you want to write the output to CSV after running:
write.csv(univar_results, "C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_GRLS_log_reg_univar.csv", row.names = FALSE)



```

Tidy up csv of univar log reg into more readable format:

```{r}
#create tidy table from univar output
source("C:/Users/ctaylor18/GitHub/HSA-VC-enviro-analyses/functions/univar_log_reg_table.R")
#read in data
univar <- read.csv("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_GRLS_log_reg_univar.csv")

#function to tidy data and write to csv in a table ready to use for univar
table <- univar_logistic_regression_table(univar,"C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_GRLS_log_reg_univar_tidied_table.csv")

#remove all the redunt variable name bits of table so just one row per variable 
blank_repeated_variable <- function(df, fill = ""){
  df$Variable <- ifelse(duplicated(df$Variable), fill, df$Variable)
  return(df)
}


table <- blank_repeated_variable(table, fill = " ") 

#crop table to keep relevant cols
table_2 <- table %>%
  dplyr::select(c(Variable,term,Case_summary,Control_summary,OR_CI,p.value,LR_T_pvalue,))
print(table_2)

print(knitr::kable(table_2, row.names=FALSE, 
    align=c("l", "l", "r", "r", "r")))

write.csv(table_2,"C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_GRLS_log_reg_univar_tidied_table2.csv")

#save table_2 as a word doc file too
doc <- read_docx()

# Convert finalfit output to a flextable
results_flextable_2 <- flextable(table_2)

# Add the flextable to the Word document
doc <- doc %>%
  body_add_flextable(results_flextable_2) %>%
  body_add_par("Finalfit Regression Results", style = "heading 1")

# Save the Word document
print(doc, target = "C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_GRLS_log_reg_univar_tidied_table2.docx")
```

Run the repro univariable analyses on only the relevant populations rather than whole cohort:

-   spayed while in heat - only on F neutered pop
-   neutered ever bred - only on neutered (M and F dogs)
-   prevent heat ever - only on F dogs
-   intact sired - only on ME dogs
-   neutered F bred with count ever - only FN
-   neutered sired litters ever - only on MN dogs
-   heats before neutering - only on FN dogs
-   num breeding before neutering tercile - only on FN and MN pop
-   ever bred from - all dogs

```{r}
#female neut
FN_pop <- cohort_abr2 %>%
  filter(sex_neuter == "F Neutered")
#male neut 
MN_pop<- cohort_abr2 %>%
  filter(sex_neuter == "M Neutered")
#both sexes neut
N_pop<- cohort_abr2 %>%
  filter(sex_neuter == "F Neutered"| sex_neuter == "M Neutered")
#male entire
ME_pop<- cohort_abr2 %>%
  filter(sex_neuter == "M Entire")
#female pop
F_pop <-cohort_abr2 %>%
  filter(sex_neuter == "F Neutered"| sex_neuter=="F Entire")


#univar for each pop


# Now run the function
#explan neut variables
#FN
explan_neut <- c("neutered_females_bred_with_count_ever","spayed_while_in_heat","spayed_while_pregnant","heats_before_neutering","heats_before_neutering_tercile","preg_pre_neuter")
univar_results_FN <- univar_logistic_regression(FN_pop, "had_HSA", explan_neut)

# If you want to write the output to CSV after running:
write.csv(univar_results_FN, "C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_GRLS_log_reg_univar_FN_pop.csv", row.names = FALSE)

#MN
explan_neut2 <- c("neutered_sired_litters_natural_ever")
univar_results_MN <- univar_logistic_regression(MN_pop, "had_HSA", explan_neut2)

# If you want to write the output to CSV after running:
write.csv(univar_results_MN, "C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_GRLS_log_reg_univar_MN_pop.csv", row.names = FALSE)
#Neut pop
explan_neut3 <- c("neutered_ever_bred","neutered_reason","num_breeding_before_neutering_tercile")
univar_results_N <- univar_logistic_regression(N_pop, "had_HSA", explan_neut3)

# If you want to write the output to CSV after running:
write.csv(univar_results_N, "C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_GRLS_log_reg_univar_N_pop.csv", row.names = FALSE)
#ME
explan_neut4 <- c("intact_sired_litters_natural_ever")
univar_results_ME<- univar_logistic_regression(ME_pop, "had_HSA", explan_neut4)

# If you want to write the output to CSV after running:
write.csv(univar_results_ME, "C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_GRLS_log_reg_univar_ME_pop.csv", row.names = FALSE)

#F pop
explan_neut5 <- c("prevent_heat_ever", "no_pregnancy_ever")
univar_results_F<- univar_logistic_regression(F_pop, "had_HSA", explan_neut5)

# If you want to write the output to CSV after running:
write.csv(univar_results_F, "C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_GRLS_log_reg_univar_F_pop.csv", row.names = FALSE)


#combine all these univar
univar_repro <- rbind(univar_results_F,univar_results_FN,univar_results_ME,univar_results_MN,univar_results_N)

write.csv(univar_repro,"C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_GRLS_log_reg_univar_all_repro_pops.csv", row.names = FALSE)



#format this univar into table for word export
#function to tidy data and write to csv in a table ready to use for univar
table <- univar_logistic_regression_table(univar_repro,"C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_GRLS_log_reg_univar_all_repro_pops_tidied_table.csv")

#remove all the redunt variable name bits of table so just one row per variable 
blank_repeated_variable <- function(df, fill = ""){
  df$Variable <- ifelse(duplicated(df$Variable), fill, df$Variable)
  return(df)
}


table <- blank_repeated_variable(table, fill = " ") 

#crop table to keep relevant cols
table_2 <- table %>%
  dplyr::select(c(Variable,term,Case_summary,Control_summary,OR_CI,p.value,LR_T_pvalue,))
print(table_2)

print(knitr::kable(table_2, row.names=FALSE, 
    align=c("l", "l", "r", "r", "r")))

write.csv(table_2,"C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_GRLS_log_reg_univar_all_repro_pops_tidied_table2.csv")

#save table_2 as a word doc file too
doc <- read_docx()

# Convert finalfit output to a flextable
results_flextable_2 <- flextable(table_2)

# Add the flextable to the Word document
doc <- doc %>%
  body_add_flextable(results_flextable_2) %>%
  body_add_par("Finalfit Regression Results", style = "heading 1")

# Save the Word document
print(doc, target = "C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_GRLS_log_reg_univar_all_repro_pops_tidied_table2.docx")
```

Run univar log reg to only retain variables where they are sig not just due to NA/not recorded variable

```{r}

check_levels <- function(df) {
  sapply(df, function(x) length(unique(na.omit(x))) >= 2)
}

# Example usage
result <- check_levels(cohort_no_not_rec)

# Print columns that do not meet the condition
names(result[result == FALSE])




cohort_no_not_rec$had_HSA <- as.factor(cohort_no_not_rec$had_HSA)

#leaving out the continuous variables as missing data causing issues
#"max_tumour_cm_value" "age_at_diagnosis_cont"
cohort_no_not_rec<- cohort_no_not_rec %>%
  dplyr::select(  #demog
  "age_at_final_date_GB","age_at_final_date_bio", "age_at_final_date_quartiles","age_at_neuter_years_quartiles","sex_neuter",
   "sex", "neuter", "mismating_ever",
             "neutered_reason", "neutered_ever_bred", "spayed_while_in_heat", "spayed_while_pregnant", "prevent_heat_ever", 
             "no_pregnancy_ever", "intact_sired_litters_natural_ever", "neutered_females_bred_with_count_ever", 
             "neutered_sired_litters_natural_ever", "heats_before_neutering", "heats_before_neutering_terciles",
             "preg_pre_neuter",
 "num_breeding_before_neutering_terciles", "ever_bred_from", 
              "avg_weight_5y_prior_endpoint_quartiles","avg_weight_5y_prior_endpoint_kg_biological", "avg_height_5y_prior_endpoint_quartiles", 
             "avg_purina_BCS_5y_prior_endpoint_quartiles", "median_weight_5y_prior_endpoint_kg_outliers_removed_quartiles","median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_quartiles", "mode_purina_BCS_5y_prior_endpoint","median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_biological","median_weight_5y_prior_endpoint_kg_outliers_removed_biological",  "mode_purina_BCS_5y_prior_endpoint", "mode_BCS_classify",
  #lifestyle/activity
  "main_lifestyle_category", 
 "main_lifestyle_category_mode_5yrs_prior", "USDA_30min_sy1_2", "activity_1h_min_sy1_2", 
             "activity_KC_2h_min_sy1_2", "avg_activity_duration_sy1_2_quartile",
 "avg_activity_intensity_sy3_quartile", "avg_intensity_5y_prior_endpoint_quartile", "avg_frequency_5y_prior_endpoint_quartile", "avg_activity_duration_sy1_2_splits",
 "avg_activity_freq_sy1_2_splits", 
             "avg_activity_freq_sy3_splits", "avg_activity_intensity_sy3_splits",  "avg_frequency_5y_prior_endpoint_splits",
             "avg_activity_freq_sy3_splits_grouped", "avg_activity_intensity_sy3_splits_grouped",  "avg_frequency_5y_prior_endpoint_splits_grouped","avg_intensity_5y_prior_endpoint_splits","avg_intensity_5y_prior_endpoint_splits_grouped",
  #home/environmental
  "MDI_quintile","owner_MDI_quintile","area_type_mode_5yrs_prior","house_type_mode_5yrs_prior", 
             "water_source_mode_5yrs_prior", "pipes_metal_any_mode_5yrs_prior", "pipes_plastic_any_mode_5yrs_prior", 
             "heating_fuel_primary_mode_5yrs_prior", "cooking_fuel_primary_mode_5yrs_prior", "heating_fuel_secondary_mode_5yrs_prior", 
             "cooking_fuel_secondary_mode_5yrs_prior", "region_mode_5y_prior","use_aerosol_study_years_early_life", "use_air_cleaner_study_years_early_life", "use_hepa_filter_study_years_early_life", 
             "use_moth_balls_study_years_early_life", "use_incense_or_candles_study_years_early_life", "smoke_exposure_study_years_early_life",  "use_aerosol_study_years_rest_of_life", 
             "use_air_cleaner_study_years_rest_of_life", "use_hepa_filter_study_years_rest_of_life", "use_moth_balls_study_years_rest_of_life", 
             "use_incense_or_candles_study_years_rest_of_life", "smoke_exposure_study_years_rest_of_life", "any_treated_weeds_study_years_rest_of_life", 
             "any_treated_insects_study_years_rest_of_life", "any_treated_fertilizer_study_years_rest_of_life","use_aerosol_study_years_whole_life", 
             "use_air_cleaner_study_years_whole_life", "use_hepa_filter_study_years_whole_life", "use_moth_balls_study_years_whole_life", 
             "use_incense_or_candles_study_years_whole_life", "smoke_exposure_study_years_whole_life", "any_treated_weeds_study_years_whole_life", 
             "any_treated_insects_study_years_whole_life", "any_treated_fertilizer_study_years_whole_life", "hours_of_smoke_early_life_total_dosage_terciles", "hours_of_smoke_rest_of_life_total_dosage_terciles", 
             "hours_of_smoke_whole_life_total_dosage_terciles", "in.the.garage_YN_study_years_early_life", "in.the.house_YN_study_years_early_life", 
             "outside_YN_study_years_early_life",  
             "in.the.garage_YN_study_years_rest_of_life", "in.the.house_YN_study_years_rest_of_life", "outside_YN_study_years_rest_of_life", 
              "in.the.house_YN_sum_rest_of_life_quartile",  
             "in.the.garage_YN_study_years_whole_life", "in.the.house_YN_study_years_whole_life", "outside_YN_study_years_whole_life", 
             "in.the.house_YN_sum_whole_life_quartile",  
             "majority_sleep_location_lifetime","sleep_location_mode_5yrs_prior", 
             "use_aerosol_exposed_5yrs_prior", "use_air_cleaner_exposed_5yrs_prior", "use_hepa_filter_exposed_5yrs_prior", 
             "use_moth_balls_exposed_5yrs_prior", "use_incense_or_candles_exposed_5yrs_prior", "smoke_exposure_exposed_5yrs_prior", 
             "any_treated_weeds_exposed_5yrs_prior", "any_treated_insects_exposed_5yrs_prior", "any_treated_fertilizer_exposed_5yrs_prior", 
  #comorbidities
  "chronic_inflam_present_lifetime","number_comorbs_present_lifetime","chronic_inflam_present.x","chronic_inflam_present_5y","number_comorbs_present_5y","chronic_inflam_present_no_min_year","number_comorbs_present_no_min_year","intestinal_parasitism","tick_borne_parasitism","other_parasitism","all_parasitism","infectious","immune_mediated","cardiovascular","gastrointestinal","inflammatory_other","orthopaedic","chronic_inflammatory","lifelong_comorb_present.x","lifelong_orthopaedic","lifelong_immune_mediated","lifelong_cardiovascular","lifelong_gastrointestinal","lifelong_inflammatory_other","lifelong_chronic_inflammatory","number_lifelong_comorbs_present","malig_cancers_count","benign_cancers_count","all_cancers_count","all_cancers_YN","benign_cancers_YN","malig_cancers_YN","all_cancers_count_no_HSA","malig_cancers_count_no_HSA","malig_cancers_YN_no_HSA","all_cancers_YN_no_HSA","lymphoma_present","carcinoma_present","sarcoma_present","melanoma_present","adenocarcinoma_present","mast_cell_tumor_present",
  #medications
  "half_anti_microbials_lifetime", "half_dietary_supplements_lifetime", 
             "half_enteric_lifetime", "half_fluid_metabolites_lifetime", "half_hormones_and_related_lifetime", "half_immunologicals_lifetime", 
             "half_misc_lifetime", "half_neurological_lifetime", "half_anti_parasites_lifetime", "half_anti_septics_lifetime", 
             "half_cardio_respiratory_lifetime", "half_diuretics_lifetime", "half_anti_hist_lifetime", 
             "quartile_anti_inflam_lifetime", "quartile_anti_microbials_lifetime", "quartile_dietary_supplements_lifetime", 
 "quartile_hormones_and_related_lifetime", 
             "quartile_immunologicals_lifetime", "quartile_misc_lifetime", "quartile_neurological_lifetime", 
             "quartile_anti_parasites_lifetime", 
             "half_anti_inflam_5y_prior_endpoint", "half_anti_microbials_5y_prior_endpoint", "half_enteric_5y_prior_endpoint", 
             "half_immunologicals_5y_prior_endpoint", "half_misc_5y_prior_endpoint", "half_neurological_5y_prior_endpoint", 
             "half_anti_parasites_5y_prior_endpoint", "half_dietary_supplements_5y_prior_endpoint", 
             "half_anti_septics_5y_prior_endpoint", "half_hormones_and_related_5y_prior_endpoint", 
             "half_cardio_respiratory_5y_prior_endpoint", "half_fluid_metabolites_5y_prior_endpoint", 
             "half_diuretics_5y_prior_endpoint", "half_anti_hist_5y_prior_endpoint", 
             "quartile_anti_inflam_5y_prior_endpoint", "quartile_anti_microbials_5y_prior_endpoint",  "quartile_immunologicals_5y_prior_endpoint", 
             "quartile_misc_5y_prior_endpoint", "quartile_neurological_5y_prior_endpoint", 
             "quartile_anti_parasites_5y_prior_endpoint", "quartile_dietary_supplements_5y_prior_endpoint", 
 "quartile_hormones_and_related_5y_prior_endpoint", "NSAID_5y","NSAID_ever","NSAID_5y_quantiles","steroid_5y","steroid_ever","fenbendazole_5y","fenbendazole_ever", "ecto_5y_quantiles","endo_5y_quantiles","had_HSA")

#remove drug not administered as an NA
cols_to_modify <- 145:193  # adjust as needed

for (i in cols_to_modify) {
  current_levels <- levels(cohort_no_not_rec[[i]])
  if ("no_medication_records_for_this_time_period" %in% current_levels) {
    # Move it to last level
    new_levels <- c(setdiff(current_levels, "no_medication_records_for_this_time_period"), "no_medication_records_for_this_time_period")
    cohort_no_not_rec[[i]] <- factor(cohort_no_not_rec[[i]], levels = new_levels)
    
    # Replace it with NA
    cohort_no_not_rec[[i]][cohort_no_not_rec[[i]] == "no_medication_records_for_this_time_period"] <- NA
  }
}
#remove "endpoint data not recorded for cancer presence" and "no_medication_records_for_this_time_periodistered" to be NAs

strings_to_replace <- c("no_medication_records_for_this_time_period", "did_not_have_endpoint_data")

cohort_no_not_rec <- cohort_no_not_rec %>%
  mutate(across(
    where(~ is.character(.) || is.factor(.)),
    ~ {
      x <- as.character(.)
      x[x %in% strings_to_replace] <- NA
      factor(x)
    }
  ))
#univar_logistic_regression(cohort_no_not_rec, "had_HSA", "C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_GRLS_log_reg_univar_no_missing.csv")

univar_table_no_missing <- cohort_no_not_rec %>%summary_factorlist(dependent, explanatory, 
  add_dependent_label=TRUE,na_include = FALSE, p=TRUE,column=TRUE)
# View the results
print(univar_table_no_missing)

write.csv(univar_table_no_missing,"C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_GRLS_log_reg_univar_no_missing.csv")

```

Potentially significant univariable variables (with NA included as "not_recorded" level)

```{r}
#not using this sect as keeping only variables with sig p for those with other levels sig besides "NA" equivalent
lrt_pvalues <-read.csv("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_GRLS_log_reg_univar.csv")
multivar_variables <- lrt_pvalues %>%
  filter(LR_T_pvalue <= 0.2) %>%
  distinct(predictor)
cols_to_keep = multivar_variables$predictor
cols_to_keep <- append(cols_to_keep, "had_HSA")
cohort_abr_sig <- cohort_abr2[,cols_to_keep]

#missing data removed for p val calculation 
pvalues_no_miss <-read.csv("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/HSA_GRLS_log_reg_univar_no_missing.csv")
multivar_variables2 <- pvalues_no_miss %>%
  filter(p <= 0.2) %>%
  distinct(Dependent..had_HSA)
cols_to_keep2 = multivar_variables2$Dependent..had_HSA
cols_to_keep2 <- append(cols_to_keep2, "had_HSA")
cols_to_keep2 <- cols_to_keep2[cols_to_keep2 != ""]

#keeping the not recorded variables
cohort_abr_sig2 <- cohort_no_not_rec[,cols_to_keep2]



#keep only these ones for the original cohort with "not_recorded" level as only want to take these ones that are actually univar sig forward to multivar model build

cohort_abr_sig <- cohort_abr2[,cols_to_keep2]

```

## Multivariable logistic regression

Assessing collinearity of potentially sig univariable variables:

```{r}
source("C:/Users/ctaylor18/GitHub/HSA-VC-enviro-analyses/functions/corr_matrix_creation.R")
#use sig variables list generated above

create_corr_matrix(cohort_abr_sig,c(1:96), "C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/hsa_corr_matrix_quartile_logreg.csv", "C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/hsa_corr_matrix_quartile_logreg2.csv","C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/hsa_corr_matrix_quartile_logreg_corrvalue.csv","C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/hsa_corr_matrix_quartile_logreg.png")
```

Correlated variables

```{r}
corr_values <- read.csv("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/hsa_corr_matrix_quartile_logreg_corrvalue.csv")

#ditch rows where variable 1 and 2 values are same as in another row :
corr_values2 <- corr_values %>%
  dplyr::select(-c(X))

corr_values3 <- corr_values2 %>%
  mutate(Var1_sorted = pmin(Variable1, Variable2),  
         Var2_sorted = pmax(Variable1, Variable2)) %>%  
  distinct(Var1_sorted, Var2_sorted, Correlation, .keep_all = TRUE) %>%  
  dplyr::select(-c(Var1_sorted, Var2_sorted))  # Remove helper columns


print(corr_values3)
```

```{r}
source("C:/Users/ctaylor18/GitHub/HSA-VC-enviro-analyses/functions/corr_matrix_creation.R")
#use sig variables list generated above

create_corr_matrix(cohort_abr_sig2,c(1:96), "C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/hsa_corr_matrix_quartile_logreg_no_missing.csv", "C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/hsa_corr_matrix_quartile_logreg2_no_missing.csv","C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/hsa_corr_matrix_quartile_logreg_corrvalue_no_missing.csv","C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/hsa_corr_matrix_quartile_logreg_no_missing.png")





corr_values <- read.csv("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/hsa_corr_matrix_quartile_logreg_corrvalue_no_missing.csv")

#ditch rows where variable 1 and 2 values are same as in another row :
corr_values2 <- corr_values %>%
  dplyr::select(-c(X))

corr_values3 <- corr_values2 %>%
  mutate(Var1_sorted = pmin(Variable1, Variable2),  
         Var2_sorted = pmax(Variable1, Variable2)) %>%  
  distinct(Var1_sorted, Var2_sorted, Correlation, .keep_all = TRUE) %>%  
  dplyr::select(-c(Var1_sorted, Var2_sorted))  # Remove helper columns


print(corr_values3)


#get number of unique values in this corr values 3
unique_var1 <- unique(corr_values3$Variable1)
unique_var2<- unique(corr_values3$Variable2)

all_unique_values <- union(unique_var1, unique_var2)

```

Correlated variables (98):

-   Comorbidities

    -   5y vs lifetime

    -   comorb inflam vs chronic inflam

    -   time between comorb and endpoint and diagnosis after comorb

    -   Malig vs all cancer counts and YN variables

-   Activity

    -   activity freq and intensity for SY3+

-   Enviro

    -   hours of smoke whole life and smoke exposure YN early life

    -   for all the exposure YN variables corr between early vs whole vs rest vs 5y prior

    -   fertilizer and weeds 5y prior

-   Repro

    -   sex and spayed in heat, no preg ever, heats before neutering,age at neuter quartile (and amongst all these variables)

    -   

-   Medications

    -   half vs quartile and lifetime vs 5y for most are correlated

    -   fluid metabolites and diuretic and antihistamines

    -   5y and ever variables for fenbendazole, NSAID and steroids

#### Automated log reg model building - does not work as doesnt consider collinearity of variables

```{r}
sig_variables <- unique(multivar_variables$predictor)

# Construct formula for full model
full_formula <- as.formula(paste("had_HSA ~", paste(sig_variables, collapse = " + ")))

# Build the null model
model_null <- glm(had_HSA ~ 1, data = cohort_abr_sig, family = binomial)

# Build the full model
model_full <- glm(full_formula, data = cohort_abr_sig, family = binomial)

# Display model summary
summary(model_full)
#check VIF of full model - doesnt run as aliased coeffs
#vif_values <- car::vif(model_full)

# Stepwise selection using both directions and LRT test
step(model_null,
     scope = list(upper = model_full),
     direction = "both",
     test = "LRT",
     data = df_for_multivar)
```

Automated model final:

```{r,eval=FALSE,error=FALSE}
model_auto <- glm(formula = had_HSA ~ age_at_final_date_quartiles + in.the.house_YN_study_years_rest_of_life + 
    avg_frequency_5y_prior_endpoint_quartile + mode_purina_BCS_5y_prior_endpoint + 
    avg_height_5y_prior_endpoint_quartile + cooking_fuel_secondary_mode_5yrs_prior + 
    in.the.house_YN_sum_whole_life_quartile + quartile_anti_parasites_5y_prior_endpoint + 
    quartile_anti_parasites_lifetime + avg_weight_5y_prior_endpoint_quartile + 
    no_pregnancy_ever + comorb_immune_mediated_chronic + number_comorbs_present_lifetime + 
    comorb_inflammatory_other + in.the.house_YN_sum_rest_of_life_quartile + 
    mismating_ever + smoke_exposure_study_years_early_life + 
    main_lifestyle_category + outside_YN_study_years_early_life, 
    family = binomial, data = cohort_abr_sig)
summary(model_auto)
#car::vif(model_auto)

dependent ="had_HSA"
explanatory2 <- c(
  "age_at_final_date_quartiles", 
  "in.the.house_YN_study_years_rest_of_life", 
  "avg_frequency_5y_prior_endpoint_quartile", 
  "mode_purina_BCS_5y_prior_endpoint", 
  "avg_height_5y_prior_endpoint_quartile", 
  "cooking_fuel_secondary_mode_5yrs_prior", 
  "in.the.house_YN_sum_whole_life_quartile", 
  "quartile_anti_parasites_5y_prior_endpoint", 
  "quartile_anti_parasites_lifetime", 
  "avg_weight_5y_prior_endpoint_quartile", 
  "no_pregnancy_ever", 
  "comorb_immune_mediated_chronic", 
  "number_comorbs_present_lifetime", 
  "comorb_inflammatory_other", 
  "in.the.house_YN_sum_rest_of_life_quartile", 
  "mismating_ever", 
  "smoke_exposure_study_years_early_life", 
  "main_lifestyle_category", 
  "outside_YN_study_years_early_life"
)

# only presenting factors not management factors - explanatory_2 <- c("haem_cs_present","mass_cs_present","no_cs_present","splenic_interest")
cohort_abr_sig %>%
  finalfit(dependent, explanatory2, metrics=TRUE) -> t2
knitr::kable(t2[[1]], row.names=FALSE, align=c("l", "l", "r", "r", "r", "r"))
knitr::kable(t2[[2]], row.names=FALSE, col.names="")
```

### Manual multivariable model building

from most significant to least (p\<0.2) :

```{r}
null_model <- glm(had_HSA ~ 1, data = cohort_abr_sig, family = binomial)

```

-   age

```{r}
#age quartile
age_model <- glm(had_HSA ~ age_at_final_date_quartiles, data = cohort_abr_sig, family = binomial)

summary(age_model)
logistic.display(age_model)
lrtest(null_model,age_model)


#age bio
age_model2 <- glm(had_HSA ~ age_at_final_date_bio, data = cohort_abr_sig, family = binomial)

summary(age_model2)
logistic.display(age_model2)
lrtest(null_model,age_model2)

#age GB
age_model3 <- glm(had_HSA ~ age_at_final_date_GB, data = cohort_abr_sig, family = binomial)

summary(age_model3)
logistic.display(age_model3)
lrtest(null_model,age_model3)
```

-   in house rest of life YN, whole life quartile

```{r}
model_2a <- glm(had_HSA ~ age_at_final_date_GB + in.the.house_YN_sum_rest_of_life_quartile, data = cohort_abr_sig, family = binomial)

summary(model_2a)
logistic.display(model_2a)
lrtest(age_model,model_2a)


model_2b <- glm(had_HSA ~ age_at_final_date_GB + in.the.house_YN_sum_whole_life_quartile, data = cohort_abr_sig, family = binomial)

summary(model_2b)
logistic.display(model_2b)
lrtest(age_model,model_2b)
```

-   all cancers count and YN

```{r}
model_4a<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA, data = cohort_abr_sig, family = binomial)

summary(model_4a)
logistic.display(model_4a)
lrtest(age_model,model_4a)
car::vif(model_4a)


model_4b<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_YN_no_HSA, data = cohort_abr_sig, family = binomial)

summary(model_4b)
logistic.display(model_4b)
lrtest(age_model,model_4b)
car::vif(model_4b)
```

-   freq and intensity 5y quartile
    -   splits and grouped trial in as well
    -   freq lower AIC for all variants of variables. Splits had lower AIC than grouped splits but more meaningful to have grouped splits = take forwards

```{r}
#quartiles
model_5a<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_quartile , data = cohort_abr_sig, family = binomial)

summary(model_5a)
logistic.display(model_5a)
lrtest(model_4a,model_5a)
car::vif(model_5a)


model_5b<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_intensity_5y_prior_endpoint_quartile , data = cohort_abr_sig, family = binomial)

summary(model_5b)
lrtest(model_4a,model_5b)
logistic.display(model_5b)

# splits
model_5c<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_intensity_5y_prior_endpoint_splits  , data = cohort_abr_sig, family = binomial)
summary(model_5c)
lrtest(model_4a,model_5c)
logistic.display(model_5c)
model_5d<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits  , data = cohort_abr_sig, family = binomial)
summary(model_5d)
lrtest(model_4a,model_5d)
logistic.display(model_5d)
#groups
model_5e<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_intensity_5y_prior_endpoint_splits_grouped  , data = cohort_abr_sig, family = binomial)
summary(model_5e)
lrtest(model_4a,model_5e)
logistic.display(model_5e)
model_5f<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  , data = cohort_abr_sig, family = binomial)
summary(model_5f)
lrtest(model_4a,model_5f)
logistic.display(model_5f)

```

-   BCS whole value
    -   only not_recorded category sig = not retained

```{r}

model_6b<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + mode_purina_BCS_5y_prior_endpoint, data = cohort_abr_sig, family = binomial)
summary(model_6b)
logistic.display(model_6b)
car::vif(model_6b)
lrtest(model_5a,model_6b)

```

-   fertiliser YN whole and rest of life
    -   doesnt improve

```{r}
model_7<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life, data = cohort_abr_sig, family = binomial)
summary(model_7)
logistic.display(model_7)
car::vif(model_7)
lrtest(model_5a,model_7)
```

-   quartile antiparasites 5y prior, half antiparasites lifetime, quartile antiparasites lifetime

```{r}
model_8a<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint, data = cohort_abr_sig, family = binomial)

summary(model_8a)
logistic.display(model_8a)
car::vif(model_8a)
lrtest(model_7,model_8a)

```

-   main lifestyle 5y
    -   no levels significant exc not_recorded

```{r}
model_9<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint+ main_lifestyle_category_mode_5yrs_prior, data = cohort_abr_sig, family = binomial)
summary(model_9)
logistic.display(model_9)
car::vif(model_9)
lrtest(model_8a,model_9)
```

-   malig cancer YN, malig cancer count cant keep in two cancer variables so assess if YN or all cancer count is better

```{r}
model_10a<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint + malig_cancers_YN_no_HSA, data = cohort_abr_sig, family = binomial)
summary(model_10a)
logistic.display(model_10a)
car::vif(model_10a)
lrtest(model_8a,model_10a)



model_10b<- glm(had_HSA ~ age_at_final_date_GB  + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint + malig_cancers_YN_no_HSA, data = cohort_abr_sig, family = binomial)
summary(model_10b)
logistic.display(model_10b)

model_10c<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint , data = cohort_abr_sig, family = binomial)
summary(model_10c)
logistic.display(model_10c)


model_10d<- glm(had_HSA ~ age_at_final_date_GB  +malig_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint , data = cohort_abr_sig, family = binomial)
summary(model_10d)
logistic.display(model_10d)
car::vif(model_10a)
logistic.display(model_10b)
car::vif(model_10a)
```

-   fenbendazole ever

```{r}
model_11<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint + fenbendazole_ever, data = cohort_abr_sig, family = binomial)

summary(model_11)
logistic.display(model_11)
car::vif(model_11)
lrtest(model_8a,model_11)
```

-   NSAID ever
-   aliased with fenbendazole_ever

```{r}
model_12<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever, data = cohort_abr_sig, family = binomial)

summary(model_12)
summary(model_11)
logistic.display(model_12)
car::vif(model_12)
lrtest(model_8a,model_12)
```

-   heats_before_neutering_tercile

```{r}
model_13<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever + heats_before_neutering_terciles, data = cohort_abr_sig, family = binomial)

summary(model_13)
logistic.display(model_13)
car::vif(model_13)
lrtest(model_12,model_13)
```

-   heating fuel
-   only not recorded category sig =not retain variable

```{r}
model_14<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever + heats_before_neutering_terciles + heating_fuel_primary_mode_5yrs_prior, data = cohort_abr_sig, family = binomial)

summary(model_14)
logistic.display(model_14)
car::vif(model_14)
lrtest(model_13,model_14)
```

-   insect treatment rest of life

```{r}
model_15<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever + heats_before_neutering_terciles + any_treated_insects_study_years_rest_of_life, data = cohort_abr_sig, family = binomial)

summary(model_15)
logistic.display(model_15)
car::vif(model_15)
lrtest(model_13,model_15)
```

-   GI comorb 5y

```{r}
model_18<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever + heats_before_neutering_terciles +  gastrointestinal, data = cohort_abr_sig, family = binomial)

summary(model_18)
logistic.display(model_18)
car::vif(model_18)
lrtest(model_13,model_18)
```

-   age at neutering
    -   non sig and tolerance issues with age at final date

```{r, error=FALSE}
model_19<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever + heats_before_neutering_terciles + gastrointestinal + age_at_neuter_years_quartiles, data = cohort_abr_sig, family = binomial)

summary(model_19)
logistic.display(model_19)
car::vif(model_19)
lrtest(model_18,model_19)
```

-   weight 5y prior

```{r}
model_21<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever + heats_before_neutering_terciles  + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles, data = cohort_abr_sig, family = binomial)

summary(model_21)
logistic.display(model_21)
car::vif(model_21)
lrtest(model_18,model_21)
```

-   NSAIDs 5y prior
    -   ever is better

```{r}
#ever
model_23a<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever + heats_before_neutering_terciles + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles , data = cohort_abr_sig, family = binomial)
summary(model_23a)
#5y
model_23b<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_5y + heats_before_neutering_terciles  + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles , data = cohort_abr_sig, family = binomial)
summary(model_23b)
```

-   sex
    -   cant keep heats before neutering and sex in together so select which is better - keep sex

```{r}
model_25<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever  + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex, data = cohort_abr_sig, family = binomial)
summary(model_25)
logistic.display(model_25)
model_25a<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever +  gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + heats_before_neutering_terciles, data = cohort_abr_sig, family = binomial)
logistic.display(model_25a)
summary(model_25a)
car::vif(model_25)
logistic.display(model_25)
lrtest(model_21,model_25)
```

-   neuter

```{r}
model_27<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter, data = cohort_abr_sig, family = binomial)
summary(model_27)
logistic.display(model_27)
car::vif(model_27)
lrtest(model_25,model_27)
```

-   half enteric 5y prior, lifetime
    -   non sig

```{r}
model_28<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever +  gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + half_enteric_5y_prior_endpoint, data = cohort_abr_sig, family = binomial)
summary(model_28)
logistic.display(model_28)
car::vif(model_28)
lrtest(model_27,model_28)

model_28<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever +  gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + half_enteric_lifetime, data = cohort_abr_sig, family = binomial)
summary(model_28)
logistic.display(model_28)
car::vif(model_28)
lrtest(model_27,model_28)
```

-   height
    -   non sig

```{r}
model_29<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + avg_height_5y_prior_endpoint_quartiles, data = cohort_abr_sig, family = binomial)
summary(model_29)
logistic.display(model_29)
car::vif(model_29)
lrtest(model_27,model_29)
```

-   number comorbs present lfietime - 2 levels have no variables , not include

```{r}
model_31<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever +  gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + number_comorbs_present_lifetime, data = cohort_abr_sig, family = binomial)
summary(model_31)
logistic.display(model_31)
car::vif(model_31)
lrtest(model_27,model_31)
```

-   outside YN early years and whole life
    -   non sig

```{r}
model_32<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + outside_YN_study_years_early_life, data = cohort_abr_sig, family = binomial)
summary(model_32)
logistic.display(model_32)
car::vif(model_32)
lrtest(model_27,model_32)
```

-   fenbendazole 5y
    -   non sig

```{r}
model_33<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever  + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + fenbendazole_5y, data = cohort_abr_sig, family = binomial)
summary(model_33)
logistic.display(model_33)
car::vif(model_33)
lrtest(model_27,model_33)
```

-   number comorbs 5y
    -   non sig

```{r}
model_35<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + number_comorbs_present_5y, data = cohort_abr_sig, family = binomial)
summary(model_35)
logistic.display(model_35)
car::vif(model_35)
lrtest(model_27,model_35)
```

-   incense rest of life
    -   non sig

```{r}
model_37<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + use_incense_or_candles_study_years_rest_of_life, data = cohort_abr_sig, family = binomial)
summary(model_37)
logistic.display(model_37)
car::vif(model_37)
lrtest(model_27,model_37)
```

-   chronic inflam 5y
    -   non sig

```{r}
model_38<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever  + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + chronic_inflammatory, data = cohort_abr_sig, family = binomial)
summary(model_38)
logistic.display(model_38)
car::vif(model_38)
lrtest(model_27,model_38)
```

-   avg purina BCS 5y quartile
    -   non sig

```{r}
model_39<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever +  gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + avg_purina_BCS_5y_prior_endpoint_quartiles, data = cohort_abr_sig, family = binomial)
summary(model_39)
logistic.display(model_39)
car::vif(model_39)
lrtest(model_27,model_39)
```

-   lifelong comorbs present YN, lifelong chronic inflam
    -   non sig

```{r}
model_40<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever +   gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + lifelong_chronic_inflammatory, data = cohort_abr_sig, family = binomial)
summary(model_40)
model_40<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever +   gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + lifelong_comorb_present.x, data = cohort_abr_sig, family = binomial)
summary(model_40)
logistic.display(model_40)
car::vif(model_40)
lrtest(model_27,model_40)
```

-   chronic inflam present YN
    -   non sig

```{r}
model_41<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + chronic_inflam_present.x, data = cohort_abr_sig, family = binomial)
summary(model_41)
logistic.display(model_41)
car::vif(model_41)
lrtest(model_27,model_41)
```

-   smoke exposure YN early lfie
    -   sig

```{r}
model_42<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever  + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + smoke_exposure_study_years_early_life, data = cohort_abr_sig, family = binomial)
summary(model_42)
logistic.display(model_42)
car::vif(model_42)
lrtest(model_27,model_42)
```

-   all parasite comorbs 5y
    -   non sig

```{r}
model_43<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever  + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + smoke_exposure_study_years_early_life+ all_parasitism, data = cohort_abr_sig, family = binomial)
summary(model_43)
logistic.display(model_43)
car::vif(model_43)
lrtest(model_42,model_43)
```

-   majority sleep location lifetime
    -   non sig

```{r}
model_45<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever +   gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter +smoke_exposure_study_years_early_life+ majority_sleep_location_lifetime, data = cohort_abr_sig, family = binomial)
summary(model_45)
logistic.display(model_45)
car::vif(model_45)
lrtest(model_42,model_45)
```

Assess activity split data incorp - duration SY1 non sig - freq 5y prior endpoint sig but quartiles better model performance

```{r}
#duration sy1_2
model_47<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever  + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter +smoke_exposure_study_years_early_life+ avg_activity_duration_sy1_2_splits, data = cohort_abr_sig, family = binomial)
summary(model_47)
logistic.display(model_47)
car::vif(model_47)
lrtest(model_42,model_47)
#freq sy3
model_47a<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever +  gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + smoke_exposure_study_years_early_life + avg_activity_freq_sy3_splits, data = cohort_abr_sig, family = binomial)
summary(model_47a)
logistic.display(model_47a)
car::vif(model_47a)
lrtest(model_42,model_47a)


#intensity sy3

#freq 5y prior quartile
model_47b<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter +smoke_exposure_study_years_early_life, data = cohort_abr_sig, family = binomial)
summary(model_47b)
logistic.display(model_47b)
#freq 5y prior endpoint splits
model_47c<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever  + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + smoke_exposure_study_years_early_life, data = cohort_abr_sig, family = binomial)
summary(model_47c)
logistic.display(model_47c)
```

Assess type of cancer present variables in model: -melanoma, lymphoma, MCT

-   lymphoma only sig from "NA" variable

-   cant keep these variables + cancer count variable so decide which one fits model better - AIC improved for both melanoma count and MCT count models vs cancer cuont model

-   cant keep melanoma AND MCT in same model as VIF issues - AIC v minimally different so choose which preferred to keep in - MCT

DISCUSSSED 15/5/25 - not keeping these in as variables as incr likelohood of endpoint dataset anything for HSA cases

```{r}
#melanoma
model_48a<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + smoke_exposure_study_years_early_life + melanoma_present, data = cohort_abr_sig, family = binomial)
summary(model_48a)
logistic.display(model_48a)
car::vif(model_48a)
lrtest(model_42,model_48a) 


#lymphoma
model_48b<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever +  gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + smoke_exposure_study_years_early_life + lymphoma_present, data = cohort_abr_sig, family = binomial)
summary(model_48b)
logistic.display(model_48b)
car::vif(model_48b)
lrtest(model_42,model_48b) 
#MCT
model_48c<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + smoke_exposure_study_years_early_life + mast_cell_tumor_present, data = cohort_abr_sig, family = binomial)
summary(model_48c)
logistic.display(model_48c)
car::vif(model_48c)
lrtest(model_42,model_48c) 


#assess if MCT and melanoma can be in model together and also if better to have these variables or cancer count - cannot have both in 
model_48d<- glm(had_HSA ~ age_at_final_date_GB  + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever  + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + smoke_exposure_study_years_early_life + mast_cell_tumor_present + melanoma_present, data = cohort_abr_sig, family = binomial)
summary(model_48d)
logistic.display(model_48d)
car::vif(model_48d)

#assess if models better with the cancer count or the presence of MCT or melanoma
model_cancer_count <- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever  + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + smoke_exposure_study_years_early_life + all_cancers_count_no_HSA, data = cohort_abr_sig, family = binomial)
summary(model_cancer_count)

model_melanoma <- glm(had_HSA ~ age_at_final_date_GB  + avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever +   gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + smoke_exposure_study_years_early_life  +melanoma_present, data = cohort_abr_sig, family = binomial)
summary(model_melanoma)
car::vif(model_melanoma)
```

Explore if can put weight biological in instead quartiles:

-equivocal = do biologicalv ersion

```{r}

```

Final model

```{r}
model_f<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA+ avg_frequency_5y_prior_endpoint_splits_grouped + any_treated_fertilizer_study_years_whole_life + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever + gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex + neuter + smoke_exposure_study_years_early_life , data = cohort_abr_sig, family = binomial)
summary(model_f)
logistic.display(model_f)
car::vif(model_f)
```

Removing variables non sig when in final model:

```{r}
model_f_quart<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_count_no_HSA+ avg_frequency_5y_prior_endpoint_splits_grouped + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever +  gastrointestinal + avg_weight_5y_prior_endpoint_quartiles + sex_neuter + smoke_exposure_study_years_early_life
              , data = cohort_abr_sig, family = binomial)
summary(model_f_quart)
logistic.display(model_f_quart)
car::vif(model_f_quart)


model_f_kg<- glm(had_HSA ~ age_at_final_date_GB  + all_cancers_count_no_HSA+ avg_frequency_5y_prior_endpoint_splits_grouped + quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever +  gastrointestinal + avg_weight_5y_prior_endpoint_kg_biological + sex_neuter + smoke_exposure_study_years_early_life
              , data = cohort_abr_sig, family = binomial)
summary(model_f_kg)
logistic.display(model_f_kg)
car::vif(model_f_kg)
```

Interaction terms assessment:

-   age and cancer count

-   cancer and weight

-   cancer and parasite tx

-   age and exercsie freq

<!-- -->

-   NSAID ever and smoke exposure are significant but only for not recorded NSAID X within early life exposure = not include

```{r}
library(broom)
# Define the variables in the model
vars <- c("age_at_final_date_GB",
          "avg_frequency_5y_prior_endpoint_splits_grouped",
          "all_cancers_count_no_HSA",
          "quartile_anti_parasites_5y_prior_endpoint",
          "NSAID_ever",
          "gastrointestinal",
          "avg_weight_5y_prior_endpoint_kg_biological",
          "sex_neuter",
          "smoke_exposure_study_years_early_life")

# Fit the base model
model_f <- glm(had_HSA ~ ., data = cohort_abr_sig[, c("had_HSA", vars)], family = binomial)

# Loop through all pairwise combinations
interaction_results <- combn(vars, 2, FUN = function(pair) {
  interaction_term <- paste(pair, collapse = ":")
  
  # Try-catch to handle any errors
  tryCatch({
    # Build interaction formula
    interaction_formula <- as.formula(
      paste("had_HSA ~", paste(vars, collapse = " + "), "+", interaction_term)
    )
    
    # Fit model with interaction
    model_interaction <- glm(interaction_formula, data = cohort_abr_sig, family = binomial)
    
    # Extract interaction p-value (if term exists in model)
    coef_summary <- summary(model_interaction)$coefficients
    if (!interaction_term %in% rownames(coef_summary)) {
      interaction_p <- NA
    } else {
      interaction_p <- coef_summary[interaction_term, "Pr(>|z|)"]
    }
    
    # LRT p-value
    lrt_p <- anova(model_f, model_interaction, test = "LRT")$`Pr(>Chi)`[2]
    
    # Return as data frame
    data.frame(
      var1 = pair[1],
      var2 = pair[2],
      interaction_term = interaction_term,
      interaction_p = interaction_p,
      lrt_p = lrt_p
    )
  }, error = function(e) {
    # In case of error, return NA row with interaction name
    data.frame(
      var1 = pair[1],
      var2 = pair[2],
      interaction_term = interaction_term,
      interaction_p = NA,
      lrt_p = NA
    )
  })
}, simplify = FALSE)

# Combine results
interaction_results_df <- do.call(rbind, interaction_results)

# Show results with significant interactions (e.g. LRT p < 0.05)
interaction_results_df %>%
  arrange(lrt_p) %>%
  filter(!is.na(lrt_p) & lrt_p < 0.05)
```

```{r}
model_f_int<- glm(had_HSA ~ age_at_final_date_GB  + avg_frequency_5y_prior_endpoint_splits_grouped + all_cancers_count_no_HSA +quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever +  gastrointestinal + avg_weight_5y_prior_endpoint_kg_biological + sex_neuter + smoke_exposure_study_years_early_life + NSAID_ever*smoke_exposure_study_years_early_life + age_at_final_date_GB*all_cancers_count_no_HSA + all_cancers_count_no_HSA*avg_weight_5y_prior_endpoint_kg_biological + all_cancers_count_no_HSA*quartile_anti_parasites_5y_prior_endpoint + age_at_final_date_GB*avg_frequency_5y_prior_endpoint_splits_grouped , data = cohort_abr_sig, family = binomial)
summary(model_f_int)
logistic.display(model_f_int)

```

Model has issues with the levels of interactions between ageX*cancer counts and ageX* frequency activity = remove before rerun

Variables that end up non-sig in full model:

-cancer X parasites

Cancer X weight is only sig for weight not recorded level = not retained

NSAID \* smoke only sig for not recorded level = not retained

= final model no interactions

```{r}
model_f_int<- glm(had_HSA ~ age_at_final_date_GB  + avg_frequency_5y_prior_endpoint_splits_grouped + all_cancers_count_no_HSA +quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever +  gastrointestinal + avg_weight_5y_prior_endpoint_kg_biological + sex_neuter + smoke_exposure_study_years_early_life + NSAID_ever*smoke_exposure_study_years_early_life  + all_cancers_count_no_HSA*avg_weight_5y_prior_endpoint_kg_biological + all_cancers_count_no_HSA*quartile_anti_parasites_5y_prior_endpoint , data = cohort_abr_sig, family = binomial)
summary(model_f_int)
logistic.display(model_f_int)

```

```{r}
model_f_int2<- glm(had_HSA ~ age_at_final_date_GB  + avg_frequency_5y_prior_endpoint_splits_grouped + all_cancers_count_no_HSA +quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever +  gastrointestinal + avg_weight_5y_prior_endpoint_kg_biological + sex_neuter + smoke_exposure_study_years_early_life + NSAID_ever*smoke_exposure_study_years_early_life   , data = cohort_abr_sig, family = binomial)
summary(model_f_int2)
logistic.display(model_f_int2)

```

Sex-neuter not sig in final model but sex is = keep sex in

Elect to swap cancer count for YN as so few values besides 0 and 1

```{r}
model_f<- glm(had_HSA ~ age_at_final_date_GB  + avg_frequency_5y_prior_endpoint_splits_grouped + all_cancers_YN_no_HSA +quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever +  gastrointestinal + avg_weight_5y_prior_endpoint_kg_biological + sex + smoke_exposure_study_years_early_life  , data = cohort_abr_sig, family = binomial)
summary(model_f)
logistic.display(model_f)
```

Double check that parasites and freq of activity truly improve model... - yes both although ? is it only for non recorded in freq?

```{r}
no_para<- glm(had_HSA ~ age_at_final_date_GB  + avg_frequency_5y_prior_endpoint_splits_grouped + all_cancers_YN_no_HSA   +NSAID_ever +  gastrointestinal + avg_weight_5y_prior_endpoint_kg_biological + sex + smoke_exposure_study_years_early_life  , data = cohort_abr_sig, family = binomial)
summary(no_para)
lrtest(no_para,model_f)

no_freq<- glm(had_HSA ~ age_at_final_date_GB   + all_cancers_YN_no_HSA +quartile_anti_parasites_5y_prior_endpoint  +NSAID_ever +  gastrointestinal + avg_weight_5y_prior_endpoint_kg_biological + sex + smoke_exposure_study_years_early_life , data = cohort_abr_sig, family = binomial)
summary(no_freq)
lrtest(no_freq,model_f)
```

Check if inclusion of NSAID quantiles helpful in model - equivocal AIC but does provide info on incr nsaid incr odds - so keep this in

```{r}
model_f2<- glm(had_HSA ~ age_at_final_date_GB  + avg_frequency_5y_prior_endpoint_splits_grouped + all_cancers_YN_no_HSA +quartile_anti_parasites_5y_prior_endpoint  +NSAID_5y_quantiles +  gastrointestinal + avg_weight_5y_prior_endpoint_kg_biological + sex + smoke_exposure_study_years_early_life  , data = cohort_abr_sig, family = binomial)
summary(model_f2)
logistic.display(model_f2)
```

Assess if better weight options than avg adult- try medians quartiles and medians biological: -AIC lowest for all 5y record median quartiles but will elect for all 5y biological

```{r}
#original weight used
model_w1<- glm(had_HSA ~ age_at_final_date_GB  + avg_frequency_5y_prior_endpoint_splits_grouped + all_cancers_YN_no_HSA +quartile_anti_parasites_5y_prior_endpoint  +NSAID_5y_quantiles +  gastrointestinal + avg_weight_5y_prior_endpoint_kg_biological + sex + smoke_exposure_study_years_early_life  , data = cohort_abr_sig, family = binomial)
summary(model_w1)
logistic.display(model_w1)
#median with all 5y records biological
model_w2<- glm(had_HSA ~ age_at_final_date_GB  + avg_frequency_5y_prior_endpoint_splits_grouped + all_cancers_YN_no_HSA +quartile_anti_parasites_5y_prior_endpoint  +NSAID_5y_quantiles +  gastrointestinal + median_weight_5y_prior_endpoint_kg_outliers_removed_biological + sex + smoke_exposure_study_years_early_life  , data = cohort_abr_sig, family = binomial)
summary(model_w2)
logistic.display(model_w2)
#median with any in 5y records biological
model_w3<- glm(had_HSA ~ age_at_final_date_GB  + avg_frequency_5y_prior_endpoint_splits_grouped + all_cancers_YN_no_HSA +quartile_anti_parasites_5y_prior_endpoint  +NSAID_5y_quantiles +  gastrointestinal + median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_biological + sex + smoke_exposure_study_years_early_life  , data = cohort_abr_sig, family = binomial)
summary(model_w3)
logistic.display(model_w3)


#median all 5y quartiles
model_w4<- glm(had_HSA ~ age_at_final_date_GB  + avg_frequency_5y_prior_endpoint_splits_grouped + all_cancers_YN_no_HSA +quartile_anti_parasites_5y_prior_endpoint  +NSAID_5y_quantiles +  gastrointestinal + median_weight_5y_prior_endpoint_kg_outliers_removed_quartiles + sex + smoke_exposure_study_years_early_life  , data = cohort_abr_sig, family = binomial)
summary(model_w4)
logistic.display(model_w4)


#median any 5y quartiles
model_w5<- glm(had_HSA ~ age_at_final_date_GB  + avg_frequency_5y_prior_endpoint_splits_grouped + all_cancers_YN_no_HSA +quartile_anti_parasites_5y_prior_endpoint  +NSAID_5y_quantiles +  gastrointestinal + median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_quartiles + sex + smoke_exposure_study_years_early_life  , data = cohort_abr_sig, family = binomial)
summary(model_w5)
logistic.display(model_w5)
```

Check if exercise freq still included - yes LRT and AIC support

```{r}
#median with all 5y records biological
model_w2<- glm(had_HSA ~ age_at_final_date_GB  + avg_frequency_5y_prior_endpoint_splits_grouped + all_cancers_YN_no_HSA +quartile_anti_parasites_5y_prior_endpoint  +NSAID_5y_quantiles +  gastrointestinal + median_weight_5y_prior_endpoint_kg_outliers_removed_biological + sex + smoke_exposure_study_years_early_life  , data = cohort_abr_sig, family = binomial)
summary(model_w2)
logistic.display(model_w2)

#median with all 5y records biological
model_nofreq<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_YN_no_HSA +quartile_anti_parasites_5y_prior_endpoint  +NSAID_5y_quantiles +  gastrointestinal + median_weight_5y_prior_endpoint_kg_outliers_removed_biological + sex + smoke_exposure_study_years_early_life  , data = cohort_abr_sig, family = binomial)
summary(model_nofreq)
logistic.display(model_nofreq)

lrtest(model_nofreq,model_w2)
```

Model performance metrics:

```{r}
  library(pscl)

# Calculate pseudo R^2
pseudo_r2 <- pR2(model_w2)
print(pseudo_r2)

library(pROC)

# Generate predicted probabilities
predicted_prob <- predict(model_w2, type = "response")

# Calculate the AUC
roc_curve <- roc(cohort_abr_sig$had_HSA, predicted_prob)
auc_value <- auc(roc_curve)
print(auc_value)

# Plot the ROC curve
plot(roc_curve, main = "ROC Curve", col = "blue", lwd = 2)
```

```{r}
dependent <- "had_HSA"

explanatory <- c(
  "age_at_final_date_GB",
  "sex",
  "median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_biological",
  "avg_frequency_5y_prior_endpoint_splits_grouped",
  "all_cancers_YN_no_HSA",
  "quartile_anti_parasites_5y_prior_endpoint",
  "NSAID_5y_quantiles",
  "gastrointestinal",
  "smoke_exposure_study_years_early_life"

)

final_model_table <- cohort_abr_sig %>%
  finalfit(dependent, explanatory, metrics = TRUE, column = TRUE) %>%
  kable(format = "html", digits = 2, escape = FALSE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

final_model_table


```


Sub in parasite individual txs of ecto vs endo:
Endo

```{r}
dependent <- "had_HSA"
#reset endo levels to be same as other all parasites model
cohort_abr_sig <- cohort_abr_sig %>%
  mutate(endo_5y_quantiles = factor(endo_5y_quantiles,
                              levels=c("Q1(1-2)","Q2(2-3)","Q3(3-4)","Q4(4-17)","no_endo_admin","no_med_use_recorded")))





explanatory <- c(
  "age_at_final_date_GB",
  "sex",
  "median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_biological",
  "avg_frequency_5y_prior_endpoint_splits_grouped",
  "all_cancers_YN_no_HSA",
  "endo_5y_quantiles",
  "NSAID_5y_quantiles",
  "gastrointestinal",
  "smoke_exposure_study_years_early_life"

)

final_model_table <- cohort_abr_sig %>%
  finalfit(dependent, explanatory, metrics = FALSE, column = TRUE) %>%
  kable(format = "html", digits = 2, escape = FALSE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

final_model_table

```

Ecto:
(NB. final fit not working as levels are same as NSAID quantiles and aliased co-efficiencts with NSAIDs quantiles) 

```{r}
model_ecto<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_YN_no_HSA +ecto_5y_quantiles  +NSAID_5y_quantiles +  gastrointestinal + median_weight_5y_prior_endpoint_kg_outliers_removed_biological + sex + smoke_exposure_study_years_early_life  , data = cohort_abr_sig, family = binomial)
car::vif(model_ecto)
summary(model_ecto)
logistic.display(model_ecto)

```

```{r}
dependent <- "had_HSA"
explanatory <- c(  "age_at_final_date_GB",
  "sex",
  "median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_biological",
  "avg_frequency_5y_prior_endpoint_splits_grouped",
  "all_cancers_YN_no_HSA",
  "quartile_anti_parasites_5y_prior_endpoint",
  "NSAID_5y_quantiles",
  "gastrointestinal",
  "smoke_exposure_study_years_early_life")
final_model_table <-cohort_abr_sig %>% 
  finalfit(dependent, explanatory, metrics = TRUE,column=TRUE) %>%
  kable(format = "html", digits = 2, escape = FALSE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))


final_model_table

final_model_table2<- cohort_abr_sig %>% 
  finalfit(dependent, explanatory, metrics = FALSE,column = TRUE) 
final_model_table2_df <- as.data.frame(final_model_table2)

results_flextable <-flextable(final_model_table2_df)



# Create a Word document
doc <- read_docx()


# Add the flextable to the Word document
doc <- doc %>%
  body_add_flextable(results_flextable) %>%
  body_add_par("Finalfit Regression Results", style = "heading 1")
print(results_flextable, target = "C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/finalfit_logreg_table_all_variables.docx")

```

```{r}
cohort_abr_sig %>%
  finalfit(dependent, explanatory, method = "glm", family = "binomial") -> logreg_model

plot <- or_plot(.data = cohort_abr_sig,
                 dependent = "had_HSA", 
                 explanatory = c(   "age_at_final_date_GB",
  "sex",
  "median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_biological",
  "avg_frequency_5y_prior_endpoint_splits_grouped",
  "all_cancers_YN_no_HSA",
  "quartile_anti_parasites_5y_prior_endpoint",
  "NSAID_5y_quantiles",
  "gastrointestinal",
  "smoke_exposure_study_years_early_life"))


plot2 <-cohort_abr_sig %>%
  or_plot(dependent, explanatory,column_space = c(-0.5, -0.1, 0.5),table_text_size = 3, plot_opts = list(xlim(0, 14)))
plot2
print(plot2)
```

### Model build with only 5y prior or no time point variables

```{r}
cols_to_keep_5y_or_no_time <- c("heating_fuel_primary_mode_5yrs_prior","cooking_fuel_secondary_mode_5yrs_prior",
                              "region_mode_5y_prior","number_comorbs_present_5y","all_parasitism","gastrointestinal","inflammatory_other","chronic_inflammatory","avg_intensity_5y_prior_endpoint_quartile","avg_frequency_5y_prior_endpoint_quartile","main_lifestyle_category_mode_5yrs_prior","use_hepa_filter_exposed_5yrs_prior","any_treated_weeds_exposed_5yrs_prior","any_treated_insects_exposed_5yrs_prior","any_treated_fertilizer_exposed_5yrs_prior","sex","neuter","spayed_while_in_heat","avg_weight_5y_prior_endpoint_quartiles","avg_weight_5y_prior_endpoint_kg_biological","avg_height_5y_prior_endpoint_quartiles","avg_purina_BCS_5y_prior_endpoint_quartiles","median_weight_5y_prior_endpoint_kg_outliers_removed_quartiles","median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_quartiles", "median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_biological","median_weight_5y_prior_endpoint_kg_outliers_removed_biological","mode_purina_BCS_5y_prior_endpoint","half_anti_inflam_5y_prior_endpoint","half_anti_microbials_5y_prior_endpoint","half_enteric_5y_prior_endpoint","half_immunologicals_5y_prior_endpoint", "half_misc_5y_prior_endpoint","half_anti_parasites_5y_prior_endpoint","half_dietary_supplements_5y_prior_endpoint","half_fluid_metabolites_5y_prior_endpoint","quartile_anti_inflam_5y_prior_endpoint","quartile_anti_microbials_5y_prior_endpoint","quartile_immunologicals_5y_prior_endpoint","quartile_misc_5y_prior_endpoint","quartile_anti_parasites_5y_prior_endpoint","quartile_dietary_supplements_5y_prior_endpoint","age_at_final_date_GB","age_at_neuter_years_quartiles","malig_cancers_count_no_HSA","all_cancers_count_no_HSA","all_cancers_count","malig_cancers_YN_no_HSA","all_cancers_YN_no_HSA","NSAID_5y","steroid_5y","fenbendazole_5y","age_at_final_date_quartiles","age_at_final_date_bio","sex_neuter","lifelong_comorb_present.x","avg_activity_duration_sy1_2_splits","avg_activity_freq_sy1_2_splits","avg_activity_freq_sy3_splits","avg_activity_intensity_sy3_splits","avg_frequency_5y_prior_endpoint_splits","avg_frequency_5y_prior_endpoint_splits_grouped","avg_intensity_5y_prior_endpoint_splits","avg_intensity_5y_prior_endpoint_splits_grouped","NSAID_5y_quantiles","had_HSA")

cohort_abr_sig_5y <- cohort_abr2[,cols_to_keep_5y_or_no_time]
  
#set levels for purina BCS mode
cohort_abr_sig_5y <- cohort_abr_sig_5y%>%
  mutate(mode_purina_BCS_5y_prior_endpoint = factor(mode_purina_BCS_5y_prior_endpoint, levels = c("5", "3", "4", "6","7","8","9","not_recorded")))



cohort_abr_sig_5y <- cohort_abr_sig_5y%>%
  mutate(age_at_final_date_GB = factor(age_at_final_date_GB, levels = c(">7-<9y","<5y", ">5-<7y",  ">9-<11y",">11-<13y",">13y")))

```

Null model

```{r}
null_model <- glm(had_HSA ~ 1, data = cohort_abr_sig_5y, family = binomial)

```

Age

```{r}
model_age1 <- glm(had_HSA ~ age_at_final_date_quartiles, data=cohort_abr_sig_5y,family=binomial)


summary(model_age1)
logistic.display(model_age1)
#car::vif(model_a)
lrtest(null_model,model_age1)

model_age2 <- glm(had_HSA ~ age_at_final_date_bio, data=cohort_abr_sig_5y,family=binomial)


summary(model_age2)
logistic.display(model_age2)
#car::vif(model_a)
lrtest(null_model,model_age2)


model_age3 <- glm(had_HSA ~ age_at_final_date_GB, data=cohort_abr_sig_5y,family=binomial)


summary(model_age3)
logistic.display(model_age3)
#car::vif(model_a)
lrtest(null_model,model_age3)
```

Cancer counts and YN

-   all cancer YN has lowest AIC but all are sig, elect to take forward only malig_cancers_YN variable as removes poss issues with benign masses

```{r}
model_cancer1 <- glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA, data=cohort_abr_sig_5y,family=binomial)


summary(model_cancer1)
logistic.display(model_cancer1)
car::vif(model_cancer1)
lrtest(model_age3,model_cancer1)


model_cancer2<- glm(had_HSA ~ age_at_final_date_GB + all_cancers_count_no_HSA, data=cohort_abr_sig_5y,family=binomial)


summary(model_cancer2)
logistic.display(model_cancer2)
car::vif(model_cancer2)
lrtest(model_age3,model_cancer2)




model_cancer3<- glm(had_HSA ~ age_at_final_date_GB + malig_cancers_count_no_HSA, data=cohort_abr_sig_5y,family=binomial)


summary(model_cancer3)
logistic.display(model_cancer3)
car::vif(model_cancer3)
lrtest(model_age3,model_cancer3)




model_cancer4<- glm(had_HSA ~ age_at_final_date_GB + malig_cancers_YN_no_HSA, data=cohort_abr_sig_5y,family=binomial)


summary(model_cancer4)
logistic.display(model_cancer4)
car::vif(model_cancer4)
lrtest(model_age3,model_cancer4)
```

Frequency and intensity 5y prior

-   keep freq - very similar values for quartile vs splits but only the not_recorded level was sig in splits

```{r}
#quartiles
model_5a<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_quartile , data = cohort_abr_sig_5y, family = binomial)

summary(model_5a)
logistic.display(model_5a)
lrtest(model_4a,model_5a)
car::vif(model_5a)


model_5b<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_YN_no_HSA + avg_intensity_5y_prior_endpoint_quartile , data = cohort_abr_sig_5y, family = binomial)

summary(model_5b)
lrtest(model_4a,model_5b)
logistic.display(model_5b)

# splits
model_5c<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_YN_no_HSA + avg_intensity_5y_prior_endpoint_splits  , data = cohort_abr_sig_5y, family = binomial)
summary(model_5c)
lrtest(model_4a,model_5c)
logistic.display(model_5c)
model_5d<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits  , data = cohort_abr_sig_5y, family = binomial)
summary(model_5d)
lrtest(model_4a,model_5d)
logistic.display(model_5d)
#groups
model_5e<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_YN_no_HSA + avg_intensity_5y_prior_endpoint_splits_grouped  , data = cohort_abr_sig_5y, family = binomial)
summary(model_5e)
lrtest(model_4a,model_5e)
logistic.display(model_5e)
model_5f<- glm(had_HSA ~ age_at_final_date_GB  +all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  , data = cohort_abr_sig_5y, family = binomial)
summary(model_5f)
lrtest(model_4a,model_5f)
logistic.display(model_5f)



```

Weeds 5y

-   non sig

```{r}
model_weed<- glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  +any_treated_weeds_exposed_5yrs_prior, data=cohort_abr_sig_5y,family=binomial)


summary(model_weed)
logistic.display(model_weed)
car::vif(model_weed)
lrtest(model_weed,model_5f)
```

Fertiliser 5y

-   non sig

```{r}
model_fert<- glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped +any_treated_weeds_exposed_5yrs_prior + any_treated_fertilizer_exposed_5yrs_prior, data=cohort_abr_sig_5y,family=binomial)


summary(model_fert)
logistic.display(model_fert)
car::vif(model_fert)
lrtest(model_weed,model_5f)
```

NSAID 5y

-   sig but weed no longer

```{r}
model_a<- glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped +any_treated_weeds_exposed_5yrs_prior + NSAID_5y, data=cohort_abr_sig_5y,family=binomial)



summary(model_a)
logistic.display(model_a)
car::vif(model_a)
lrtest(model_5f,model_a)

model_a1<- glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped + NSAID_5y, data=cohort_abr_sig_5y,family=binomial)
```

Half anti-inflam 5y/quartile anti-inflam

-   both non sig in model (and not collinear with VIF)

```{r}
model_b1 <- glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y + half_anti_inflam_5y_prior_endpoint, data=cohort_abr_sig_5y,family=binomial)


summary(model_b1)
logistic.display(model_b1)
car::vif(model_b1)
lrtest(model_a1,model_b1)

model_b2 <- glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y +  quartile_anti_inflam_5y_prior_endpoint, data=cohort_abr_sig_5y,family=binomial)


summary(model_b2)
logistic.display(model_b2)
car::vif(model_b2)
lrtest(model_a1,model_b2)
```

Half immunologicals 5y/quartile

-   non sig

```{r}
model_c1 <- glm(had_HSA ~age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + half_immunologicals_5y_prior_endpoint, data=cohort_abr_sig_5y,family=binomial)


summary(model_c1)
logistic.display(model_c1)
car::vif(model_c1)
lrtest(model_a1,model_c1)

model_c2 <- glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y + quartile_immunologicals_5y_prior_endpoint, data=cohort_abr_sig_5y,family=binomial)


summary(model_c2)
logistic.display(model_c2)
car::vif(model_c2)
lrtest(model_a1,model_c2)
```

Half antiparasites 5y

-   not sig

```{r}
model_d <- glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y + half_anti_parasites_5y_prior_endpoint, data=cohort_abr_sig_5y,family=binomial)


summary(model_d)
logistic.display(model_d)
car::vif(model_d)
lrtest(model_a1,model_d)
```

sex-neuter, sex, neuter

-   sex or sex-neuter lowest AIC, neuter not sig alone as variable

```{r}
#sex
model_e1 <- glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex, data=cohort_abr_sig_5y,family=binomial)


summary(model_e1)
logistic.display(model_e1)
car::vif(model_e1)
lrtest(model_a1,model_e1)
#sex neut
model_e2 <- glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex_neuter, data=cohort_abr_sig_5y,family=binomial)


summary(model_e2)
logistic.display(model_e2)
car::vif(model_e2)
lrtest(model_a1,model_e2)
#neut

model_e3 <- glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + neuter, data=cohort_abr_sig_5y,family=binomial)


summary(model_e3)
logistic.display(model_e3)
car::vif(model_e3)
lrtest(model_a1,model_e3)
```

region mode 5y

-non sig

```{r}

model_f <- glm(had_HSA ~age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex_neuter + region_mode_5y_prior, data=cohort_abr_sig_5y,family=binomial)
summary(model_f)
logistic.display(model_f)
car::vif(model_f)
lrtest(model_e2,model_f)
```

age at neuter quartile

-   cant have with age at final date variable

```{r}

model_g <- glm(had_HSA ~age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex_neuter + age_at_neuter_years_quartiles, data=cohort_abr_sig_5y,family=binomial)
summary(model_g)
logistic.display(model_g)
car::vif(model_g)
lrtest(model_e2,model_g)
```

half dietary supp 5y

-   not sig

```{r}
model_h <- glm(had_HSA ~age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex_neuter + half_dietary_supplements_5y_prior_endpoint, data=cohort_abr_sig_5y,family=binomial)
summary(model_h)
logistic.display(model_h)
car::vif(model_h)
lrtest(model_e2,model_h)
```

fenbendazole 5y

-   collinear with NSAID_5y

-   NSAID lower AIC so keep instead

```{r}
model_i <- glm(had_HSA ~age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex_neuter + fenbendazole_5y, data=cohort_abr_sig_5y,family=binomial)
summary(model_i)
logistic.display(model_i)
car::vif(model_i)
lrtest(model_e2,model_i)


model_i2 <- glm(had_HSA ~age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped   + sex_neuter + fenbendazole_5y, data=cohort_abr_sig_5y,family=binomial)
summary(model_i2)
logistic.display(model_i2)
car::vif(model_i2)
lrtest(model_e2,model_i2)
```

main lifestyle category 5y

-   only not recorded var csategory is sig= not retain

```{r}
model_j <- glm(had_HSA ~age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex_neuter + main_lifestyle_category_mode_5yrs_prior, data=cohort_abr_sig_5y,family=binomial)
summary(model_j)
logistic.display(model_j)
car::vif(model_j)
lrtest(model_e2,model_j)
```

half antimicrobials 5y

-   noyt sig

```{r}
model_k <- glm(had_HSA ~age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex_neuter + half_anti_microbials_5y_prior_endpoint, data=cohort_abr_sig_5y,family=binomial)
summary(model_k)
logistic.display(model_k)
car::vif(model_k)
lrtest(model_e2,model_k)
```

avg purina BCS 5y

-   not sig

```{r}
model_l <- glm(had_HSA ~age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex_neuter + avg_purina_BCS_5y_prior_endpoint_quartiles, data=cohort_abr_sig_5y,family=binomial)
summary(model_l)
logistic.display(model_l)
car::vif(model_l)
lrtest(model_e2,model_l)
```

lifelong comorb present

-   not sig

```{r}
model_m <- glm(had_HSA ~age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex_neuter + lifelong_comorb_present.x, data=cohort_abr_sig_5y,family=binomial)
summary(model_m)
logistic.display(model_m)
car::vif(model_m)
lrtest(model_e2,model_m)

```

chronic inflam 5y

-   not sig

```{r}
model_n <- glm(had_HSA ~age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex_neuter + chronic_inflammatory, data=cohort_abr_sig_5y,family=binomial)
summary(model_n)
logistic.display(model_n)
car::vif(model_n)
lrtest(model_e2,model_n)
```

inflammatory other

-   not sig

```{r}
model_o <- glm(had_HSA ~age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex_neuter + inflammatory_other, data=cohort_abr_sig_5y,family=binomial)
summary(model_o)
logistic.display(model_o)
car::vif(model_o)
lrtest(model_e2,model_o)
```

all parasitism

-   not sig

```{r}
model_p <- glm(had_HSA ~age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex_neuter + all_parasitism, data=cohort_abr_sig_5y,family=binomial)
summary(model_p)
logistic.display(model_p)
car::vif(model_p)
lrtest(model_e2,model_p)
```

steroid 5y

-   collinear with NSAID 5y, NSAID better fit

```{r}
model_q <- glm(had_HSA ~age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex_neuter + steroid_5y, data=cohort_abr_sig_5y,family=binomial)
summary(model_q)
logistic.display(model_q)
car::vif(model_q)
lrtest(model_e2,model_q)
```

number comorbs present 5y

-   not sig

```{r}
model_r <- glm(had_HSA ~age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex_neuter + number_comorbs_present_5y, data=cohort_abr_sig_5y,family=binomial)
summary(model_r)
logistic.display(model_r)
car::vif(model_r)
lrtest(model_e2,model_r)
```

hepa filter 5y

-not sig

```{r}
model_s <- glm(had_HSA ~age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex_neuter + use_hepa_filter_exposed_5yrs_prior, data=cohort_abr_sig_5y,family=binomial)
summary(model_s)
logistic.display(model_s)
car::vif(model_s)
lrtest(model_e2,model_s)
```

quartile antimicrobials 5y

-   not isg

```{r}
model_t <- glm(had_HSA ~age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex_neuter + use_hepa_filter_exposed_5yrs_prior, data=cohort_abr_sig_5y,family=binomial)
summary(model_t)
logistic.display(model_t)
car::vif(model_t)
lrtest(model_e2,model_t)
```

mode purina BCS 5y

-   sig although only for not recorded catregory

```{r}
model_u <- glm(had_HSA ~age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex_neuter + mode_purina_BCS_5y_prior_endpoint, data=cohort_abr_sig_5y,family=binomial)
summary(model_u)
logistic.display(model_u)
car::vif(model_u)
lrtest(model_e2,model_u)
```

height 5y

-   not sig exc not recorded

```{r}
model_v<- glm(had_HSA ~age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex_neuter + avg_height_5y_prior_endpoint_quartiles, data=cohort_abr_sig_5y,family=binomial)
summary(model_v)
logistic.display(model_v)
car::vif(model_v)
lrtest(model_e2,model_v)
```

heating fuel primary 5y

```{r}
model_w <- glm(had_HSA ~age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex_neuter + heating_fuel_primary_mode_5yrs_prior, data=cohort_abr_sig_5y,family=binomial)
summary(model_w)
logistic.display(model_w)
car::vif(model_w)
lrtest(model_e2,model_w)
```

Weight in quartiles and biological

-   similar AIC so elect for biological

```{r}
model_weight_q <-glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA + avg_weight_5y_prior_endpoint_quartiles+ avg_frequency_5y_prior_endpoint_splits_grouped  + NSAID_5y  + sex_neuter , data=cohort_abr_sig_5y,family=binomial)
summary(model_weight_q)
logistic.display(model_weight_q)
lrtest(model_e2,model_weight_q)


model_weight_kg <-glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped+ avg_weight_5y_prior_endpoint_kg_biological + NSAID_5y  + sex_neuter , data=cohort_abr_sig_5y,family=binomial)
summary(model_weight_kg)
logistic.display(model_weight_kg)
lrtest(model_e2,model_weight_kg)
```

Trialling NSAID quartiles

-   equivocal AIC = keep in quartiles as more informative

```{r}
model_weight_kg <-glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped+ avg_weight_5y_prior_endpoint_kg_biological + NSAID_5y  + sex_neuter , data=cohort_abr_sig_5y,family=binomial)
summary(model_weight_kg)

model_weight_kg2 <-glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped+ avg_weight_5y_prior_endpoint_kg_biological + NSAID_5y_quantiles  + sex_neuter , data=cohort_abr_sig_5y,family=binomial)
summary(model_weight_kg2)
logistic.display(model_weight_kg2)
```

Trialling different weight versions

-   quartiles AIC lower than biologiclal but all median ones are lower AIC than avg

```{r}
#avg kg
model_weight_kg <-glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped+ avg_weight_5y_prior_endpoint_kg_biological + NSAID_5y_quantiles  + sex_neuter , data=cohort_abr_sig_5y,family=binomial)
summary(model_weight_kg)
# median bio all 5y records
model_weight_kg2 <-glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped+ median_weight_5y_prior_endpoint_kg_outliers_removed_biological + NSAID_5y_quantiles  + sex_neuter , data=cohort_abr_sig_5y,family=binomial)
summary(model_weight_kg2)
logistic.display(model_weight_kg2)
#median quart all 5y records
model_weight_kg3 <-glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped+ median_weight_5y_prior_endpoint_kg_outliers_removed_quartiles + NSAID_5y_quantiles  + sex_neuter , data=cohort_abr_sig_5y,family=binomial)
summary(model_weight_kg3)
logistic.display(model_weight_kg3)
#media bio any 5y records
model_weight_kg4 <-glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped+ median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_biological + NSAID_5y_quantiles  + sex_neuter , data=cohort_abr_sig_5y,family=binomial)
summary(model_weight_kg4)
logistic.display(model_weight_kg4)
#median quart any 5y records
model_weight_kg5 <-glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA + avg_frequency_5y_prior_endpoint_splits_grouped+ median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_quartiles + NSAID_5y_quantiles  + sex_neuter , data=cohort_abr_sig_5y,family=binomial)
summary(model_weight_kg5)
logistic.display(model_weight_kg5)
```

Final model output with time restricted variables: H&L p=0.07 C statistics 0.8

```{r}
model_weight_kg <-glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA +  median_weight_5y_prior_endpoint_kg_outliers_removed_biological + NSAID_5y_quantiles  + sex_neuter ,data=cohort_abr_sig_5y,family=binomial)
summary(model_weight_kg)
logistic.display(model_weight_kg)



model_weight_kg_freq <-glm(had_HSA ~ age_at_final_date_GB + all_cancers_YN_no_HSA +  median_weight_5y_prior_endpoint_kg_outliers_removed_biological + NSAID_5y_quantiles  + sex_neuter +avg_frequency_5y_prior_endpoint_splits_grouped ,data=cohort_abr_sig_5y,family=binomial)
summary(model_weight_kg_freq)
logistic.display(model_weight_kg_freq)
lrtest(model_weight_kg,model_weight_kg_freq)
```

Sub in parasite specific treatments (ecto and endo) into this final model :

```{r}

```



```{r}
dependent <- "had_HSA"
explanatory <- c("age_at_final_date_GB","sex_neuter","all_cancers_YN_no_HSA","median_weight_5y_prior_endpoint_kg_outliers_removed_biological","NSAID_5y_quantiles","avg_frequency_5y_prior_endpoint_splits_grouped")
final_model_table5 <-cohort_abr_sig_5y %>% 
  finalfit(dependent, explanatory, metrics = TRUE,column=TRUE) %>%
  kable(format = "html", digits = 2, escape = FALSE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

final_model_table5

final_model_table5<- cohort_abr_sig_5y %>% 
  finalfit(dependent, explanatory, metrics = FALSE) 
final_model_table5_df <- as.data.frame(final_model_table5)

results_flextable <-flextable(final_model_table5_df)



# Create a Word document
doc <- read_docx()


# Add the flextable to the Word document
doc <- doc %>%
  body_add_flextable(results_flextable) %>%
  body_add_par("Finalfit Regression Results", style = "heading 1")
print(results_flextable, target = "C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/finalfit_logreg_table_5y_restricted_variables.docx")

```

```{r}
cohort_abr_sig_5y %>%
  finalfit(dependent, explanatory, method = "glm", family = "binomial") -> logreg_model

plot <- or_plot(.data = cohort_abr_sig,
                 dependent = "had_HSA", 
                 explanatory = c("age_at_final_date_GB","sex_neuter","median_weight_5y_prior_endpoint_kg_outliers_removed_biological","all_cancers_YN_no_HSA","avg_frequency_5y_prior_endpoint_splits_grouped","NSAID_5y_quantiles"))


plot2 <-cohort_abr_sig_5y %>%
  or_plot(dependent, explanatory,column_space = c(-0.5, -0.1, 0.5),table_text_size = 3, plot_opts = list(xlim(0, 6)))
plot2
print(plot2)
```

## Forest plots of final models

Make nice and labelled forestplots of final model with correct levels of variables: - using code in this for HSA VC Cox model figures C:/Users/ctaylor18/GitHub/HSA-VC-survival-analyses/HSA-VC-survival-analyses/code/Figures for survival analyses of haemangiosarcoma cases in VC.qmd All years

Data manip for plotting manually :

```{r}
cohort_abr_sig <- cohort_abr_sig %>%
  mutate(quartile_anti_parasites_5y_prior_endpoint = factor(quartile_anti_parasites_5y_prior_endpoint, levels = c("Q1","Q2", "Q3",  "Q4","no_medication_records_for_this_time_period")))

dependent <- "had_HSA"
explanatory <- c(   "age_at_final_date_GB",
  "sex",
  "median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_biological",

  "all_cancers_YN_no_HSA",
  "gastrointestinal",
    "quartile_anti_parasites_5y_prior_endpoint",
  "NSAID_5y_quantiles",
  "avg_frequency_5y_prior_endpoint_splits_grouped",
  "smoke_exposure_study_years_early_life")
final_model_table <-cohort_abr_sig %>% 
  finalfit(dependent, explanatory, metrics = TRUE,column=TRUE) %>%
  kable(format = "html", digits = 2, escape = FALSE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

final_model_table

final_model_table2<- cohort_abr_sig %>% 
  finalfit(dependent, explanatory, metrics = FALSE,column = TRUE) 
final_model_table2_df <- as.data.frame(final_model_table2)

results_flextable <-flextable(final_model_table2_df)

#recode into tidier variables
#seperate df for recoding to avoid overwriting orignal df
df <-cohort_abr_sig

#relabel from 0/1 Q1-Q4 etc
#parasites
df <- df %>%
mutate(
    quartile_anti_parasites_5y_prior_endpoint = recode(as.character(quartile_anti_parasites_5y_prior_endpoint),
                          "Q1" = "1-2 times",
                          "Q2" = ">2-4 times",
                          "Q3" = ">4-6 times",
                          "Q4" = ">6-20 times",
                          "no_medication_records_for_this_time_period" = "No medications records for this time period")
  )
df <- df %>%   
  mutate(quartile_anti_parasites_5y_prior_endpoint = factor(quartile_anti_parasites_5y_prior_endpoint,levels=c(
    "1-2 times",">2-4 times",">4-6 times",">6-20 times","No medications records for this time period"
  )))
#mct
df <- df %>%
mutate(
    all_cancers_YN_no_HSA= recode(as.character(all_cancers_YN_no_HSA),
                          "0" = "No other cancer reported",
                          "1" = "Other cancer reported")
)
    
df <- df %>%   
  mutate(all_cancers_YN_no_HSA = factor(all_cancers_YN_no_HSA,levels=c(
    "No other cancer reported","Other cancer reported"
  )))
  


#GI comorb
df <- df %>%
mutate(
    gastrointestinal = recode(as.character(gastrointestinal),
                          "0" = "GI comorb not present",
                          "1" = "GI comorb present")
    )

df <- df %>%   
  mutate(gastrointestinal = factor(gastrointestinal,levels=c(
    "GI comorb not present","GI comorb present"
  )))
#NSAID ever
df <- df %>%
mutate(
    NSAID_5y_quantiles = recode(as.character(NSAID_5y_quantiles),
                          "no_NSAID_admin" = "NSAID not administered",
                          "Q1(1)" = "1 time",
                          "Q2(1-2)" = "2 times",
                          "Q3(2-3)"="3 times",
                        "Q4(3-11)" ="4-11 times",
                        "no_med_use_recorded"="No medical records in time period")
  )

df <- df %>%   
  mutate(NSAID_5y_quantiles = factor(NSAID_5y_quantiles,levels=c(
    "NSAID not administered","1 time","2 times","3 times","4-11 times","No medical records in time period"
  )))
  
#frequency activity quartile 
df <- df %>%
  mutate(
    avg_frequency_5y_prior_endpoint_splits_grouped = recode(as.character(avg_frequency_5y_prior_endpoint_splits_grouped),
      "daily_or_more" = "Daily or more",
      "rarely" = "Rarely",
      "weekly" = "Weekly",
      "not_recorded" = "Activity freq. not recorded"
    ),
    avg_frequency_5y_prior_endpoint_splits_grouped = factor(
      avg_frequency_5y_prior_endpoint_splits_grouped,
      levels = c( 
                 "Weekly","Daily or more","Rarely",
        "Activity freq. not recorded"
      )
    )
  )


#remove univar
final_df <-df%>%
  finalfit(dependent, explanatory)

#final_df <- final_df %>%
 # rename('variable'=`Dependent: survival_time_group`)%>%
  #dplyr::select(-c('OR (univariable)')) %>%
  #dplyr::select(-c('0'))%>%
   # dplyr::select(-c('1'))
final_df <- final_df %>%
  rename('variable'=`Dependent: had_HSA`)%>%
  dplyr::select(-c('OR (univariable)'))
#replace all - with 1(1-1)

final_df$`OR (multivariable)`[#replace all - with 1(1-1)
final_df $`OR (multivariable)` == "-"] <- "1(1-1, p<0.001)"

#extracting values with regex

final_df$estimate <- gsub("([0-9.]+)\\s*\\([0-9.-]+-([0-9.-]+),\\s*p[=<]*([0-9.]+).*\\)", "\\1", final_df$`OR (multivariable)`)
final_df$conf.low <- gsub("([0-9.]+)\\s*\\(([0-9.-]+)-([0-9.-]+),\\s*p[=<]*([0-9.]+).*\\)", "\\2", final_df$`OR (multivariable)`)
final_df$conf.high <- gsub("([0-9.]+)\\s*\\([0-9.-]+-([0-9.-]+),\\s*p[=<]*([0-9.]+).*\\)", "\\2",  final_df$`OR (multivariable)`)
final_df$p.value <- gsub(".*p[=<]*([0-9.]+).*", "\\1", final_df$`OR (multivariable)`)


colnames(final_df)[2] <- "category"
final_df <- final_df %>%
  rename(OR_CI = 'OR (multivariable)')
final_df <- final_df %>%
  rename(Cases = '1')
final_df <- final_df %>%
  rename(Controls = '0')





#For index for plotting
final_df$AutoNumber <- seq_along(final_df[[1]])

#rename 1(1-1) to reference

final_df$OR_CI[#replace all - with 1(1-1)
final_df$OR_CI == "1(1-1, p<0.001)"] <- "Reference"


#renaming variables for figure
final_df[12, 2] <- "Weight not recorded"
final_df[11,2]<-">35kg"
final_df[7,2] <- "Female"
final_df[8,2]<- "Male"
final_df[1, 1] <- "Age at final date (Barry)"
final_df[7, 1] <- "Sex"
final_df[13,1] <- "Cancer recorded 5y prior to endpoint"
final_df[9, 1] <- "Median adult weight 5y prior to endpoint (biological)"
final_df[15, 1] <- "Gastrointestinal comorbidity 5y prior to endpoint"
final_df[17, 1] <- "Anti-parasites - 5y prior to endpoint (quartiles)"
final_df[22, 1] <- "NSAID usage - 5y prior to endpoint (quartiles)"
final_df[28, 1] <- "Avg. activity freq. scoreâ€“ 5y prior to endpoint (grouped)"
final_df[32, 1] <- "Smoke exposure- early life"




final_df$category <- factor(final_df$category, 
                        levels = c(">7-<9y","<5y",">5-<7y",">9-<11y",">11-<13y",">13y","Female","Male",">15-<=25kg",">25-<=35kg",">35kg","Weight not recorded","No other cancer reported","Other cancer reported", "GI comorb not present", "GI comorb present","1-2 times",">2-4 times",">4-6 times",">6-20 times","No medications records for this time period", "NSAID not administered", "1 time","2 times","3 times","4-11 times", "No medical records in time period",
                                   "Weekly","Daily or more","Rarely","Activity freq. not recorded","Not within early life", "Within early life"))
final_df$AutoNumber <- factor(final_df$AutoNumber, 
                        levels = c("1","2","3","4","5","6","7","8","9","10","11","12",
                                   "13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33"))




final_df$conf.high <- as.numeric(final_df$conf.high)
final_df$conf.low <- as.numeric(final_df$conf.low)
final_df$estimate <- as.numeric(final_df$estimate)  
```

Plot itself

```{r}
library(ggplot2)
library(patchwork)
library(forcats)

# Mid plot with adjusted dimensions
p_mid <- 
  final_df |>
  ggplot(aes(y = fct_rev(AutoNumber))) +
  theme_classic() +
  geom_point(aes(x = estimate), shape = 15, size = 5) +
  geom_linerange(aes(xmin = conf.low, xmax = conf.high)) +
  labs(x = "Odds Ratio") +
  coord_cartesian(ylim = c(1, 33), xlim = c(0, 4)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  theme(
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank(),
    axis.title.y = element_blank()
  )

# Left plot with more spaced columns and adjusted xlim
p_left <- 
  final_df |>
  ggplot(aes(y = fct_rev(AutoNumber))) + 
  geom_text(aes(x = 0, label = variable), hjust = 0, size = 4, fontface = "bold") +
  geom_text(aes(x = 25, label = category), hjust = 0, fontface = "bold", size = 3.5) +
    geom_text(aes(x = 45, label = Controls), hjust = 0, fontface = "bold", size = 3.5)+
      geom_text(aes(x = 50, label = Cases), hjust = 0, fontface = "bold", size = 3.5)+
  geom_text(aes(x = 60, label = OR_CI), hjust = 0, 
            fontface = ifelse(final_df$OR_CI == "Odds Ratio (95% CI)", "bold", "plain"), 
            size = 3.5) +
  theme_void() +
  coord_cartesian(xlim = c(0, 80))  # Allows room for three text columns



layout2 <- c(
  patchwork::area(t = 0, l = 0, b = 30, r = 9),  # Make p_left wider# top, left, bottom, right
  patchwork::area(t = 1, l = 9, b = 30, r = 15)    # p_mid occupies a smaller part
)




# Combine plots with adjusted layout
forest_log <- p_left + p_mid + plot_layout(design = layout2)
forest_log


ggsave("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/logreg_forestplot_casecontrol_numbers2.pdf", plot = forest_log, width = 25, height = 15, dpi = 300)

ggsave("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/logreg_forestplot_casecontrol_numbers2.svg", plot = forest_log, width = 25, height = 15, dpi = 300)

ggsave("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/logreg_forestplot_casecontrol_numbers2.tif", plot = forest_log, width = 25, height = 15, dpi = 300)


ggsave("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/logreg_forestplot2.pdf", plot = forest_log, width = 25, height = 15, dpi = 300)

ggsave("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/logreg_forestplot2.svg", plot = forest_log, width = 25, height = 15, dpi = 300)


ggsave("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/logreg_forestplot2.tif", plot = forest_log, width = 25, height = 15, dpi = 300)
```


Final model with endoparasite quartiles subed in:
```{r}


dependent <- "had_HSA"
explanatory <- c(   "age_at_final_date_GB",
  "sex",
  "median_weight_5y_prior_endpoint_any_records_kg_outliers_removed_biological",

  "all_cancers_YN_no_HSA",
  "gastrointestinal",
    "endo_5y_quantiles",
  "NSAID_5y_quantiles",
  "avg_frequency_5y_prior_endpoint_splits_grouped",
  "smoke_exposure_study_years_early_life")
final_model_table <-cohort_abr_sig %>% 
  finalfit(dependent, explanatory, metrics = TRUE,column=TRUE) %>%
  kable(format = "html", digits = 2, escape = FALSE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

final_model_table

final_model_table2<- cohort_abr_sig %>% 
  finalfit(dependent, explanatory, metrics = FALSE,column = TRUE) 
final_model_table2_df <- as.data.frame(final_model_table2)

results_flextable <-flextable(final_model_table2_df)

#recode into tidier variables
#seperate df for recoding to avoid overwriting orignal df
df <-cohort_abr_sig

#relabel from 0/1 Q1-Q4 etc
#parasites
df <- df %>%
mutate(
    endo_5y_quantiles = recode(as.character(endo_5y_quantiles),
                          "no_endo_admin" = "Endoparasiticide not administered",
                          "Q1(1-2)" = "1-2 times",
                          "Q2(2-3)" = "3 times ",
                          "Q3(3-4)"="4 times",
                        "Q4(4-17)" ="5-17 times",
                        "no_med_use_recorded"="No medical records in time period")
  )
df <- df %>%   
  mutate(endo_5y_quantiles = factor(endo_5y_quantiles,levels=c(
    "1-2 times","3 times ","4 times","5-17 times","Endoparasiticide not administered","No medical records in time period"
=======
  mutate(endo_5y_quantiles = factor(endo_5y_quantiles,levels=c("Endoparasiticide not administered",
    "1-2 times","3 times ","4 times","5-17 times","No medical records in time period"
  )))
#mct
df <- df %>%
mutate(
    all_cancers_YN_no_HSA= recode(as.character(all_cancers_YN_no_HSA),
                          "0" = "No other cancer reported",
                          "1" = "Other cancer reported")
)
    
df <- df %>%   
  mutate(all_cancers_YN_no_HSA = factor(all_cancers_YN_no_HSA,levels=c(
    "No other cancer reported","Other cancer reported"
  )))
  


#GI comorb
df <- df %>%
mutate(
    gastrointestinal = recode(as.character(gastrointestinal),
                          "0" = "GI comorb not present",
                          "1" = "GI comorb present")
    )

df <- df %>%   
  mutate(gastrointestinal = factor(gastrointestinal,levels=c(
    "GI comorb not present","GI comorb present"
  )))
#NSAID ever
df <- df %>%
mutate(
    NSAID_5y_quantiles = recode(as.character(NSAID_5y_quantiles),
                          "no_NSAID_admin" = "NSAID not administered",
                          "Q1(1)" = "1 time",
                          "Q2(1-2)" = "2 times",
                          "Q3(2-3)"="3 times",
                        "Q4(3-11)" ="4-11 times",
                        "no_med_use_recorded"="No medical records in time period")
  )

df <- df %>%   
  mutate(NSAID_5y_quantiles = factor(NSAID_5y_quantiles,levels=c(
    "NSAID not administered","1 time","2 times","3 times","4-11 times","No medical records in time period"
  )))
  
#frequency activity quartile 
df <- df %>%
  mutate(
    avg_frequency_5y_prior_endpoint_splits_grouped = recode(as.character(avg_frequency_5y_prior_endpoint_splits_grouped),
      "daily_or_more" = "Daily or more",
      "rarely" = "Rarely",
      "weekly" = "Weekly",
      "not_recorded" = "Activity freq. not recorded"
    ),
    avg_frequency_5y_prior_endpoint_splits_grouped = factor(
      avg_frequency_5y_prior_endpoint_splits_grouped,
      levels = c( 
                 "Weekly","Daily or more","Rarely",
        "Activity freq. not recorded"
      )
    )
  )


#remove univar
final_df <-df%>%
  finalfit(dependent, explanatory)

#final_df <- final_df %>%
 # rename('variable'=`Dependent: survival_time_group`)%>%
  #dplyr::select(-c('OR (univariable)')) %>%
  #dplyr::select(-c('0'))%>%
   # dplyr::select(-c('1'))
final_df <- final_df %>%
  rename('variable'=`Dependent: had_HSA`)%>%
  dplyr::select(-c('OR (univariable)'))
#replace all - with 1(1-1)

final_df$`OR (multivariable)`[#replace all - with 1(1-1)
final_df $`OR (multivariable)` == "-"] <- "1(1-1, p<0.001)"

#extracting values with regex

final_df$estimate <- gsub("([0-9.]+)\\s*\\([0-9.-]+-([0-9.-]+),\\s*p[=<]*([0-9.]+).*\\)", "\\1", final_df$`OR (multivariable)`)
final_df$conf.low <- gsub("([0-9.]+)\\s*\\(([0-9.-]+)-([0-9.-]+),\\s*p[=<]*([0-9.]+).*\\)", "\\2", final_df$`OR (multivariable)`)
final_df$conf.high <- gsub("([0-9.]+)\\s*\\([0-9.-]+-([0-9.-]+),\\s*p[=<]*([0-9.]+).*\\)", "\\2",  final_df$`OR (multivariable)`)
final_df$p.value <- gsub(".*p[=<]*([0-9.]+).*", "\\1", final_df$`OR (multivariable)`)


colnames(final_df)[2] <- "category"
final_df <- final_df %>%
  rename(OR_CI = 'OR (multivariable)')
final_df <- final_df %>%
  rename(Cases = '1')
final_df <- final_df %>%
  rename(Controls = '0')





#For index for plotting
final_df$AutoNumber <- seq_along(final_df[[1]])

#rename 1(1-1) to reference

final_df$OR_CI[#replace all - with 1(1-1)
final_df$OR_CI == "1(1-1, p<0.001)"] <- "Reference"


#renaming variables for figure
final_df[12, 2] <- "Weight not recorded"
final_df[11,2]<-">35kg"
final_df[7,2] <- "Female"
final_df[8,2]<- "Male"
final_df[1, 1] <- "Age at final date (Barry)"
final_df[7, 1] <- "Sex"
final_df[13,1] <- "Cancer recorded 5y prior to endpoint"
final_df[9, 1] <- "Median adult weight 5y prior to endpoint (biological)"
final_df[15, 1] <- "Gastrointestinal comorbidity 5y prior to endpoint"
final_df[17, 1] <- "Endoparasiticide - 5y prior to endpoint (quartiles)"
final_df[23, 1] <- "NSAID usage - 5y prior to endpoint (quartiles)"
final_df[29, 1] <- "Avg. activity freq. scoreâ€“ 5y prior to endpoint (grouped)"
final_df[33, 1] <- "Smoke exposure- early life"





final_df$category <- factor(final_df$category, 
                        levels = c(">7-<9y","<5y",">5-<7y",">9-<11y",">11-<13y",">13y","Female","Male",">15-<=25kg",">25-<=35kg",">35kg","Weight not recorded","No other cancer reported","Other cancer reported", "GI comorb not present", "GI comorb present","1-2 times","3 times ","4 times","5-17 times","Endoparasiticide not administered","No medications records for this time period", "NSAID not administered", "1 time","2 times","3 times","4-11 times", "No medical records in time period","Weekly","Daily or more","Rarely","Activity freq. not recorded","Not within early life", "Within early life"))
=======
final_df$category <- factor(final_df$category, 
                        levels = c(">7-<9y","<5y",">5-<7y",">9-<11y",">11-<13y",">13y","Female","Male",">15-<=25kg",">25-<=35kg",">35kg","Weight not recorded","No other cancer reported","Other cancer reported", "GI comorb not present", "GI comorb present","Endoparasiticide not administered","1-2 times","3 times ","4 times","5-17 times","No medications records for this time period", "NSAID not administered", "1 time","2 times","3 times","4-11 times", "No medical records in time period","Weekly","Daily or more","Rarely","Activity freq. not recorded","Not within early life", "Within early life"))
final_df$AutoNumber <- factor(final_df$AutoNumber, 
                        levels = c("1","2","3","4","5","6","7","8","9","10","11","12",
                                   "13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34"))




final_df$conf.high <- as.numeric(final_df$conf.high)
final_df$conf.low <- as.numeric(final_df$conf.low)
final_df$estimate <- as.numeric(final_df$estimate)  
```

```{r}
library(ggplot2)
library(patchwork)
library(forcats)

# Mid plot with adjusted dimensions
p_mid <- 
  final_df |>
  ggplot(aes(y = fct_rev(AutoNumber))) +
  theme_classic() +
  geom_point(aes(x = estimate), shape = 15, size = 5) +
  geom_linerange(aes(xmin = conf.low, xmax = conf.high)) +
  labs(x = "Odds Ratio") +
  coord_cartesian(ylim = c(1, 33), xlim = c(0, 4)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  theme(
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank(),
    axis.title.y = element_blank()
  )

# Left plot with more spaced columns and adjusted xlim
p_left <- 
  final_df |>
  ggplot(aes(y = fct_rev(AutoNumber))) + 
  geom_text(aes(x = 0, label = variable), hjust = 0, size = 4, fontface = "bold") +
  geom_text(aes(x = 25, label = category), hjust = 0, fontface = "bold", size = 3.5) +
    geom_text(aes(x = 45, label = Controls), hjust = 0, fontface = "bold", size = 3.5)+
      geom_text(aes(x = 50, label = Cases), hjust = 0, fontface = "bold", size = 3.5)+
  geom_text(aes(x = 60, label = OR_CI), hjust = 0, 
            fontface = ifelse(final_df$OR_CI == "Odds Ratio (95% CI)", "bold", "plain"), 
            size = 3.5) +
  theme_void() +
  coord_cartesian(xlim = c(0, 80))  # Allows room for three text columns



layout2 <- c(
  patchwork::area(t = 0, l = 0, b = 30, r = 9),  # Make p_left wider# top, left, bottom, right
  patchwork::area(t = 1, l = 9, b = 30, r = 15)    # p_mid occupies a smaller part
)




# Combine plots with adjusted layout
forest_log <- p_left + p_mid + plot_layout(design = layout2)
forest_log


ggsave("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/logreg_forestplot_casecontrol_numbers_endo.pdf", plot = forest_log, width = 25, height = 15, dpi = 300)

ggsave("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/logreg_forestplot_casecontrol_numbers_endo.svg", plot = forest_log, width = 25, height = 15, dpi = 300)

ggsave("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/logreg_forestplot_casecontrol_numbers_endo.tif", plot = forest_log, width = 25, height = 15, dpi = 300)


ggsave("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/logreg_forestplot_2_endo.pdf", plot = forest_log, width = 25, height = 15, dpi = 300)

ggsave("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/logreg_forestplot_2_endo.svg", plot = forest_log, width = 25, height = 15, dpi = 300)


ggsave("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/logreg_forestplot_2_endo.tif", plot = forest_log, width = 25, height = 15, dpi = 300)

ggsave("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/logreg_forestplot_2_endo_2.tif", plot = forest_log, width = 15, height = 10, dpi = 300)
=======

```

Create seperate endo only values plot to put underneath



5y/non time levels

```{r}


dependent <- "had_HSA"
explanatory <- c("age_at_final_date_GB","sex_neuter","avg_weight_5y_prior_endpoint_kg_biological","all_cancers_YN_no_HSA","NSAID_5y","avg_frequency_5y_prior_endpoint_splits_grouped")
final_model_table <-cohort_abr_sig_5y %>% 
  finalfit(dependent, explanatory, metrics = TRUE,column=TRUE) %>%
  kable(format = "html", digits = 2, escape = FALSE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

final_model_table

final_model_table2<- cohort_abr_sig_5y %>% 
  finalfit(dependent, explanatory, metrics = FALSE,column = TRUE) 
final_model_table2_df <- as.data.frame(final_model_table2)

results_flextable <-flextable(final_model_table2_df)

#recode into tidier variables
#seperate df for recoding to avoid overwriting orignal df
df <-cohort_abr_sig_5y

#relabel from 0/1 Q1-Q4 etc
#parasites

df <- df %>%
mutate(
    quartile_anti_parasites_5y_prior_endpoint = recode(as.character(quartile_anti_parasites_5y_prior_endpoint),
                          "Q1" = "1-2 times",
                          "Q2" = ">2-4 times",
                          "Q3" = ">4-6 times",
                          "Q4" = ">6-20 times",
                          "no_medication_records_for_this_time_period" = "No medications records for this time period")
  )
df <- df %>%   
  mutate(quartile_anti_parasites_5y_prior_endpoint = factor(quartile_anti_parasites_5y_prior_endpoint,levels=c(
    "1-2 times",">2-4 times",">4-6 times",">6-20 times","No medications records for this time period"
  )))
df <- df %>%
mutate(
    all_cancers_YN_no_HSA= recode(as.character(all_cancers_YN_no_HSA),
                          "0" = "No other cancer reported",
                          "1" = "Other cancer reported")
)
    
df <- df %>%   
  mutate(all_cancers_YN_no_HSA = factor(all_cancers_YN_no_HSA,levels=c(
    "No other cancer reported","Other cancer reported"
  )))
  


#GI comorb
df <- df %>%
mutate(
    gastrointestinal = recode(as.character(gastrointestinal),
                          "0" = "GI comorb not present",
                          "1" = "GI comorb present")
    )

df <- df %>%   
  mutate(gastrointestinal = factor(gastrointestinal,levels=c(
    "GI comorb not present","GI comorb present"
  )))
#NSAID ever
df <- df %>%
mutate(
    NSAID_5y = recode(as.character(NSAID_5y),
                          "0" = "NSAID not administered",
                          "1" = "NSAID administered",
                          "no_medication_records_for_this_time_period" = "No medications records for time period")
  )

df <- df %>%   
  mutate(NSAID_5y = factor(NSAID_5y,levels=c(
    "NSAID not administered","NSAID administered","No medications records for time period"
  )))
  
#frequency activity quartile 
df <- df %>%
  mutate(
    avg_frequency_5y_prior_endpoint_splits_grouped = recode(as.character(avg_frequency_5y_prior_endpoint_splits_grouped),
      "daily_or_more" = "Daily or more",
      "rarely" = "Rarely",
      "weekly" = "Weekly",
      "not_recorded" = "Activity freq. not recorded"
    ),
    avg_frequency_5y_prior_endpoint_splits_grouped = factor(
      avg_frequency_5y_prior_endpoint_splits_grouped,
      levels = c("Daily or more",
                 "Weekly",
                 "Rarely",
        "Activity freq. not recorded"
      )
    )
  )


#remove univar
final_df <-df%>%
  finalfit(dependent, explanatory)

#final_df <- final_df %>%
 # rename('variable'=`Dependent: survival_time_group`)%>%
  #dplyr::select(-c('OR (univariable)')) %>%
  #dplyr::select(-c('0'))%>%
   # dplyr::select(-c('1'))
final_df <- final_df %>%
  rename('variable'=`Dependent: had_HSA`)%>%
  dplyr::select(-c('OR (univariable)'))
#replace all - with 1(1-1)

final_df$`OR (multivariable)`[#replace all - with 1(1-1)
final_df $`OR (multivariable)` == "-"] <- "1(1-1, p<0.001)"

#extracting values with regex

final_df$estimate <- gsub("([0-9.]+)\\s*\\([0-9.-]+-([0-9.-]+),\\s*p[=<]*([0-9.]+).*\\)", "\\1", final_df$`OR (multivariable)`)
final_df$conf.low <- gsub("([0-9.]+)\\s*\\(([0-9.-]+)-([0-9.-]+),\\s*p[=<]*([0-9.]+).*\\)", "\\2", final_df$`OR (multivariable)`)
final_df$conf.high <- gsub("([0-9.]+)\\s*\\([0-9.-]+-([0-9.-]+),\\s*p[=<]*([0-9.]+).*\\)", "\\2",  final_df$`OR (multivariable)`)
final_df$p.value <- gsub(".*p[=<]*([0-9.]+).*", "\\1", final_df$`OR (multivariable)`)


colnames(final_df)[2] <- "category"
final_df <- final_df %>%
  rename(OR_CI = 'OR (multivariable)')
final_df <- final_df %>%
  rename(Cases = '1')
final_df <- final_df %>%
  rename(Controls = '0')





#For index for plotting
final_df$AutoNumber <- seq_along(final_df[[1]])

#rename 1(1-1) to reference

final_df$OR_CI[#replace all - with 1(1-1)
final_df$OR_CI == "1(1-1, p<0.001)"] <- "Reference"


#renaming variables for figure
final_df[14, 2] <- "Weight not recorded"
final_df[13,2]<-">35kg"
final_df[1, 1] <- "Age at final date (Barry)"
final_df[7, 1] <- "Sex-neuter status"
final_df[15,1] <- "Cancer recorded 5y prior to endpoint"
final_df[11, 1] <- "Avg. adult weight 5y prior to endpoint (biological)"
final_df[17, 1] <- "NSAID used - 5y prior to endpoint"
final_df[20, 1] <- "Avg. activity freq. scoreâ€“ 5y prior to endpoint (grouped)"



final_df$category <- factor(final_df$category, 
                        levels = c(">7-<9y","<5y",">5-<7y",">9-<11y",">11-<13y",">13y","F Entire","F Neutered","M Entire", "M Neutered",">15-<=25kg",">25-<=35kg",">35kg","Weight not recorded","No other cancer reported","Other cancer reported",  "NSAID not administered", "NSAID administered", "No medications records for time period","Daily or more",
                                   "Weekly","Rarely","Activity freq. not recorded"))
final_df$AutoNumber <- factor(final_df$AutoNumber, 
                        levels = c("1","2","3","4","5","6","7","8","9","10","11","12",
                                   "13","14","15","16","17","18","19","20","21","22","23"))





final_df$conf.high <- as.numeric(final_df$conf.high)
final_df$conf.low <- as.numeric(final_df$conf.low)
final_df$estimate <- as.numeric(final_df$estimate)  



```

```{r}
library(ggplot2)
library(patchwork)
library(forcats)

# Mid plot with adjusted dimensions
p_mid <- 
  final_df |>
  ggplot(aes(y = fct_rev(AutoNumber))) +
  theme_classic() +
  geom_point(aes(x = estimate), shape = 15, size = 5) +
  geom_linerange(aes(xmin = conf.low, xmax = conf.high)) +
  labs(x = "Odds Ratio") +
  coord_cartesian(ylim = c(1, 23), xlim = c(0, 10)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  theme(
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank(),
    axis.title.y = element_blank()
  )

# Left plot with more spaced columns and adjusted xlim
p_left <- 
  final_df |>
  ggplot(aes(y = fct_rev(AutoNumber))) + 
  geom_text(aes(x = 0, label = variable), hjust = 0, size = 4, fontface = "bold") +
  geom_text(aes(x = 25, label = category), hjust = 0, fontface = "bold", size = 3.5) +
    geom_text(aes(x = 45, label = Controls), hjust = 0, fontface = "bold", size = 3.5)+
      geom_text(aes(x = 50, label = Cases), hjust = 0, fontface = "bold", size = 3.5)+
  geom_text(aes(x = 60, label = OR_CI), hjust = 0, 
            fontface = ifelse(final_df$OR_CI == "Odds Ratio (95% CI)", "bold", "plain"), 
            size = 3.5) +
  theme_void() +
  coord_cartesian(xlim = c(0, 80))  # Allows room for three text columns



layout2 <- c(
  patchwork::area(t = 0, l = 0, b = 30, r = 9),  # Make p_left wider# top, left, bottom, right
  patchwork::area(t = 1, l = 9, b = 30, r = 15)    # p_mid occupies a smaller part
)




# Combine plots with adjusted layout
forest_log <- p_left + p_mid + plot_layout(design = layout2)
forest_log


ggsave("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/logreg_forestplot_casecontrol_numbers5y.pdf", plot = forest_log, width = 25, height = 15, dpi = 300)

ggsave("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/logreg_forestplot_casecontrol_numbers5y.svg", plot = forest_log, width = 25, height = 15, dpi = 300)

ggsave("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/logreg_forestplot_casecontrol_numbers5y.tif", plot = forest_log, width = 25, height = 15, dpi = 300)


ggsave("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/logreg_forestplot5y.pdf", plot = forest_log, width = 25, height = 15, dpi = 300)

ggsave("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/logreg_forestplot5y.svg", plot = forest_log, width = 25, height = 15, dpi = 300)


ggsave("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/logreg_forestplot5y.tif", plot = forest_log, width = 25, height = 15, dpi = 300)
```

Create different NSAIDs submodel?

```{r}

```
