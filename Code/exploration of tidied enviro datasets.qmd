---
title: "Exploring tidied environmental data"
format: html
editor: visual
---

## Checking tidied environmental datasets

```{r}
library(tidyverse)
library(ggplot2)
```

Environmental dataset that doesnt use endpoint data (just study years for exposure calculations)

This dataset contains:

```{r}
enviro_tidy <- read.csv("C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/lifetime_sleep_smoking_enviro_lifestyle_enviro.csv")

enviro_tidy_abr <- enviro_tidy %>%
  dplyr::select(-c(1,3:17))
```

Plot the dataset out with a barplot for each column exc subject id:

```{r}

#barplots for char variables:


for (col in names(enviro_tidy_abr)[-1]) {
  p<- ggplot(enviro_tidy_abr, aes_string(x = col)) +
    geom_bar() +
    labs(title = paste("Bar plot of", col), x = col, y = "Count") +
    theme_minimal() 
  print(p)# Print each plot
}


```

Histograms of smoke:

```{r}
ggplot(enviro_tidy_abr, aes(x = hours_of_smoke_rest_of_life_total_dosage)) +
geom_histogram(bins = 20)
```

```{r}
ggplot(enviro_tidy_abr, aes(x = hours_of_smoke_early_life_total_dosage)) +
geom_histogram(bins = 20)
```

```{r}
ggplot(enviro_tidy_abr, aes(x = hours_of_smoke_whole_life_total_dosage)) +
geom_histogram(bins = 20)
```

Add in endpoints data to determine if adequate variation between lymphoma vs not lymphoma dogs

```{r}
dead_dogs <- read.csv("C:/Users/ctaylor18/GitHub/GRLS_analyses/Data/study_endpoints.csv")

lymphoma_dogs <- dead_dogs %>%
filter(grepl("lymphoma", tracked_condition, ignore.case = TRUE))
write.csv(lymphoma_dogs,"C:/Users/ctaylor18/GitHub/GRLS_analyses/Output/lymphoma_endpoints.csv")

dead_dogs <- dead_dogs %>%
  mutate(had_lymphoma = ifelse(grepl("lymphoma", tracked_condition, ignore.case = TRUE), "had_lymphoma", "no_lymphoma"))
table(dead_dogs$had_lymphoma)

dead_subject_ids <- unique(dead_dogs$subject_id)
```

```{r}
enviro_tidy_dead_only <- enviro_tidy_abr %>%
  filter(subject_id %in% dead_subject_ids)

lymphoma_abr <- dead_dogs %>%
  dplyr::select(c(subject_id,had_lymphoma))
enviro_tidy_dead_only <- enviro_tidy_dead_only %>%
  left_join(lymphoma_abr,by="subject_id")
```

Now rerun all the plots above but with overlay for lymphoma vs no lymphoma also

```{r,eval=FALSE}



for (col in names(enviro_tidy_dead_only)[-1]) {
  p <- ggplot(enviro_tidy_dead_only, aes_string(x = col, fill = "had_lymphoma")) +
    geom_bar(position = "dodge") +  # 'dodge' to place bars side by side
    labs(title = paste("Bar plot of", col), x = col, y = "Count") +
    theme_minimal()
  print(p)  # Explicitly print each plot
}



```

As there is a 1:10 case:control ratio here its less clear which variables have good variation between them.

Calculate proportions for case:control categories to determine which to take forward?

```{r}
cols <- colnames(enviro_tidy_dead_only %>%
  dplyr::select(c(-1,-86)))
for (col in cols) {
  df_plot <- enviro_tidy_dead_only %>%
    group_by(.data[[col]], had_lymphoma) %>%  # group by the current column and 'had_lymphoma'
    count() %>%
    group_by(had_lymphoma) %>%  # group by 'had_lymphoma' to calculate proportions within each category
    mutate(proportion = n / sum(n) * 100)
  
  # Create the plot
  p <- ggplot(df_plot, aes_string(x = col, y = "proportion", fill = "had_lymphoma")) +
    geom_bar(stat = "identity", position = "dodge") +  # 'dodge' to place bars side by side
    labs(title = paste("Percentage of", col, "by had_lymphoma"), x = col, y = "Percentage") +
    theme_minimal()
  print(p)  # Explicitly print each plot
}
```

(For the non-RP2 project explore differences in time before exposure variables and the early/rest/total life variables created)

### Choose reduced number of variables for the RP2 lymphoma projects:

Set criteria for variable inclusion eg. X% in each variable category?

Ideally get this down to \~ 30 variables
